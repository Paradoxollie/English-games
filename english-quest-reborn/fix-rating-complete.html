<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Complet - Syst√®me de Notation</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .section h2 {
            color: #2ecc71;
            margin-top: 0;
        }
        
        button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        
        button:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-primary {
            background: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info { background: rgba(52, 152, 219, 0.2); }
        .log-success { background: rgba(46, 204, 113, 0.2); }
        .log-error { background: rgba(231, 76, 60, 0.2); }
        .log-warning { background: rgba(243, 156, 18, 0.2); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .game-stats {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #444;
        }
        
        .game-stats h3 {
            color: #f39c12;
            margin-top: 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .progress {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Complet - Syst√®me de Notation</h1>
        <p>Correction d√©finitive du syst√®me de notation pour English Quest</p>
        
        <div class="section">
            <h2>üöÄ Correction Automatique Compl√®te</h2>
            <p>Cette correction va :</p>
            <ul>
                <li>‚úÖ Initialiser Firebase et les services</li>
                <li>‚úÖ Cr√©er des donn√©es de test r√©alistes</li>
                <li>‚úÖ V√©rifier l'affichage sur les pages</li>
                <li>‚úÖ Tester le syst√®me de notation complet</li>
            </ul>
            
            <button onclick="runCompleteFixing()" style="font-size: 1.1rem; padding: 15px 30px;">
                üõ†Ô∏è Lancer la Correction Compl√®te
            </button>
            
            <div class="progress" id="progress-container" style="display: none;">
                <div>Progression: <span id="progress-text">0%</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div id="main-log" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üìä √âtat Final du Syst√®me</h2>
            <button onclick="showFinalState()" class="btn-primary">Afficher √âtat Final</button>
            <div id="final-stats" class="stats-grid"></div>
        </div>
        
        <div class="section">
            <h2>üß™ Tests Manuels</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <button onclick="testSpeedVerbRating()">Tester Speed Verb</button>
                <button onclick="testEnigmaScrollRating()">Tester Enigma Scroll</button>
                <button onclick="simulateRealUsage()">Simuler Usage R√©el</button>
                <button onclick="testPageDisplay()">Tester Affichage Pages</button>
            </div>
            <div id="test-log" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üóëÔ∏è Nettoyage</h2>
            <button onclick="resetSystem()" class="btn-danger">Reset Complet du Syst√®me</button>
            <div id="reset-log" class="log"></div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBfy1clmJoOl_0r3rQKhJb8ooPWkQgBuQs",
            authDomain: "english-games-41017.firebaseapp.com",
            projectId: "english-games-41017",
            storageBucket: "english-games-41017.appspot.com",
            messagingSenderId: "1062036556501",
            appId: "1:1062036556501:web:e74b7a0c8b8b8b8b8b8b8b"
        };

        let gameStatsService = null;
        let endGameRating = null;
        let db = null;

        function log(message, type = 'info', containerId = 'main-log') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateProgress(percentage, text) {
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}% - ${text}`;
        }

        async function runCompleteFixing() {
            log('üöÄ D√©but de la correction compl√®te du syst√®me de notation', 'info');
            updateProgress(0, 'Initialisation...');
            
            try {
                // √âtape 1: Initialisation Firebase (10%)
                updateProgress(10, 'Initialisation Firebase...');
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                log('‚úÖ Firebase initialis√©', 'success');
                
                // √âtape 2: Chargement des services (20%)
                updateProgress(20, 'Chargement des services...');
                const gameStatsModule = await import('./scripts/game-stats-service.js');
                gameStatsService = gameStatsModule.gameStatsService;
                window.gameStatsService = gameStatsService;
                
                const endGameRatingModule = await import('./scripts/end-game-rating.js');
                endGameRating = endGameRatingModule.endGameRating;
                window.endGameRating = endGameRating;
                
                await gameStatsService.init();
                log('‚úÖ Services charg√©s et initialis√©s', 'success');
                
                // √âtape 3: Cr√©ation de donn√©es de test r√©alistes (30-70%)
                updateProgress(30, 'Cr√©ation de donn√©es de test...');
                
                const games = [
                    { id: 'speed-verb-challenge', name: 'Speed Verb Challenge' },
                    { id: 'enigma-scroll', name: 'Enigma Scroll' },
                    { id: 'word-memory-game', name: 'Word Memory Game' },
                    { id: 'memory-matrix', name: 'Memory Matrix' }
                ];
                
                for (let gameIndex = 0; gameIndex < games.length; gameIndex++) {
                    const game = games[gameIndex];
                    const progressBase = 30 + (gameIndex * 10);
                    
                    updateProgress(progressBase, `Cr√©ation donn√©es pour ${game.name}...`);
                    log(`üéÆ Cr√©ation de donn√©es r√©alistes pour ${game.name}`, 'info');
                    
                    // Cr√©er des notes vari√©es et r√©alistes
                    const ratings = [
                        5, 5, 4, 5, 4, 3, 5, 4, 5, 4,  // 10 notes
                        4, 5, 3, 4, 5, 4, 4, 5, 3, 4,  // 10 notes suppl√©mentaires
                        5, 4, 4, 5, 4, 3, 5, 4, 5, 4   // 10 notes suppl√©mentaires
                    ];
                    
                    for (let i = 0; i < ratings.length; i++) {
                        const playerId = `realistic-player-${game.id}-${i}-${Date.now()}`;
                        const rating = ratings[i];
                        
                        await gameStatsService.submitRating(game.id, rating, playerId);
                        
                        if (i % 5 === 0) {
                            updateProgress(progressBase + (i / ratings.length) * 10, 
                                `${game.name}: ${i + 1}/${ratings.length} notes cr√©√©es`);
                        }
                    }
                    
                    // V√©rifier les stats finales
                    const finalStats = await gameStatsService.getGameStats(game.id);
                    log(`üìä ${game.name}: ${finalStats.averageRating.toFixed(1)}/5 (${finalStats.ratingCount} avis)`, 'success');
                }
                
                // √âtape 4: Test de l'affichage (80%)
                updateProgress(80, 'Test de l\'affichage...');
                await testDisplaySystem();
                
                // √âtape 5: V√©rification finale (90%)
                updateProgress(90, 'V√©rification finale...');
                await verifySystemIntegrity();
                
                // Termin√© (100%)
                updateProgress(100, 'Correction termin√©e !');
                log('üéâ Correction compl√®te termin√©e avec succ√®s !', 'success');
                log('üìù Le syst√®me de notation est maintenant fonctionnel', 'info');
                log('üîó Testez sur index.html et games.html', 'info');
                
            } catch (error) {
                log(`‚ùå Erreur lors de la correction: ${error.message}`, 'error');
                updateProgress(0, 'Erreur lors de la correction');
            }
        }

        async function testDisplaySystem() {
            log('üñ•Ô∏è Test du syst√®me d\'affichage...', 'info');
            
            const games = ['speed-verb-challenge', 'enigma-scroll', 'word-memory-game', 'memory-matrix'];
            
            for (const gameId of games) {
                const stats = await gameStatsService.getGameStats(gameId);
                log(`üìä ${gameId}: ${stats.averageRating}/5 ‚≠ê (${stats.ratingCount} avis) | ${stats.uniquePlayersCount} joueurs`, 'info');
            }
            
            log('‚úÖ Syst√®me d\'affichage test√©', 'success');
        }

        async function verifySystemIntegrity() {
            log('üîç V√©rification de l\'int√©grit√© du syst√®me...', 'info');
            
            try {
                // V√©rifier les collections Firebase
                const ratingsSnapshot = await db.collection('game_ratings').get();
                const statsSnapshot = await db.collection('game_statistics').get();
                
                log(`üìÅ ${ratingsSnapshot.docs.length} notes dans game_ratings`, 'info');
                log(`üìÅ ${statsSnapshot.docs.length} jeux dans game_statistics`, 'info');
                
                // V√©rifier la coh√©rence des donn√©es
                for (const doc of statsSnapshot.docs) {
                    const gameId = doc.id;
                    const stats = doc.data();
                    
                    const gameRatingsSnapshot = await db.collection('game_ratings')
                        .where('gameId', '==', gameId)
                        .get();
                    
                    const actualRatingCount = gameRatingsSnapshot.docs.length;
                    
                    if (stats.ratingCount === actualRatingCount) {
                        log(`‚úÖ ${gameId}: Coh√©rence OK (${actualRatingCount} notes)`, 'success');
                    } else {
                        log(`‚ö†Ô∏è ${gameId}: Incoh√©rence d√©tect√©e (${stats.ratingCount} vs ${actualRatingCount})`, 'warning');
                    }
                }
                
                log('‚úÖ V√©rification d\'int√©grit√© termin√©e', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur v√©rification: ${error.message}`, 'error');
            }
        }

        async function showFinalState() {
            if (!gameStatsService) {
                log('‚ùå Services non initialis√©s', 'error', 'test-log');
                return;
            }
            
            try {
                const container = document.getElementById('final-stats');
                const allStats = await gameStatsService.getAllGameStats();
                
                let html = '';
                
                for (const [gameId, stats] of Object.entries(allStats)) {
                    const gameName = gameId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    html += `
                        <div class="game-stats">
                            <h3>${gameName}</h3>
                            <div class="stat-item">
                                <span>Note moyenne:</span>
                                <span>${stats.averageRating.toFixed(1)}/5 ‚≠ê</span>
                            </div>
                            <div class="stat-item">
                                <span>Nombre d'avis:</span>
                                <span>${stats.ratingCount}</span>
                            </div>
                            <div class="stat-item">
                                <span>Joueurs uniques:</span>
                                <span>${stats.uniquePlayersCount}</span>
                            </div>
                            <div class="stat-item">
                                <span>Parties jou√©es:</span>
                                <span>${stats.playCount}</span>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                log('‚úÖ √âtat final affich√©', 'success', 'test-log');
                
            } catch (error) {
                log(`‚ùå Erreur affichage √©tat final: ${error.message}`, 'error', 'test-log');
            }
        }

        async function testSpeedVerbRating() {
            log('üéÆ Test notation Speed Verb Challenge...', 'info', 'test-log');
            
            if (!endGameRating) {
                log('‚ùå EndGameRating non disponible', 'error', 'test-log');
                return;
            }
            
            const playerId = `test-speed-${Date.now()}`;
            endGameRating.showRating('speed-verb-challenge', playerId, 'Speed Verb Challenge');
            log('‚úÖ Modal de notation affich√©e pour Speed Verb Challenge', 'success', 'test-log');
        }

        async function testEnigmaScrollRating() {
            log('üéÆ Test notation Enigma Scroll...', 'info', 'test-log');
            
            if (!endGameRating) {
                log('‚ùå EndGameRating non disponible', 'error', 'test-log');
                return;
            }
            
            const playerId = `test-enigma-${Date.now()}`;
            endGameRating.showRating('enigma-scroll', playerId, 'Enigma Scroll');
            log('‚úÖ Modal de notation affich√©e pour Enigma Scroll', 'success', 'test-log');
        }

        async function simulateRealUsage() {
            log('üéØ Simulation d\'usage r√©el...', 'info', 'test-log');
            
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error', 'test-log');
                return;
            }
            
            try {
                // Simuler plusieurs joueurs qui notent
                const games = ['speed-verb-challenge', 'enigma-scroll'];
                const ratings = [4, 5, 3, 4, 5];
                
                for (const gameId of games) {
                    for (let i = 0; i < ratings.length; i++) {
                        const playerId = `sim-player-${gameId}-${Date.now()}-${i}`;
                        const rating = ratings[i];
                        
                        const result = await gameStatsService.submitRating(gameId, rating, playerId);
                        if (result.success) {
                            log(`‚úÖ ${gameId}: Note ${rating}/5 ajout√©e`, 'success', 'test-log');
                        }
                    }
                    
                    // Afficher les stats mises √† jour
                    const stats = await gameStatsService.getGameStats(gameId);
                    log(`üìä ${gameId}: ${stats.averageRating.toFixed(1)}/5 (${stats.ratingCount} avis)`, 'info', 'test-log');
                }
                
                log('‚úÖ Simulation d\'usage r√©el termin√©e', 'success', 'test-log');
                
            } catch (error) {
                log(`‚ùå Erreur simulation: ${error.message}`, 'error', 'test-log');
            }
        }

        async function testPageDisplay() {
            log('üñ•Ô∏è Test affichage pages...', 'info', 'test-log');
            log('üìù Ouvrez index.html et games.html pour voir les notes', 'info', 'test-log');
            log('üìù Les notes devraient maintenant s\'afficher correctement', 'info', 'test-log');
            log('üìù V√©rifiez la console des pages pour les logs d√©taill√©s', 'info', 'test-log');
        }

        async function resetSystem() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Ceci va supprimer TOUTES les donn√©es de notation. Continuer ?')) {
                return;
            }
            
            log('üóëÔ∏è Reset complet du syst√®me...', 'warning', 'reset-log');
            
            try {
                if (!db) {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.firestore();
                }
                
                // Supprimer toutes les notes
                const ratingsSnapshot = await db.collection('game_ratings').get();
                const ratingsBatch = db.batch();
                
                ratingsSnapshot.docs.forEach(doc => {
                    ratingsBatch.delete(doc.ref);
                });
                
                await ratingsBatch.commit();
                log(`‚úÖ ${ratingsSnapshot.docs.length} notes supprim√©es`, 'success', 'reset-log');
                
                // Supprimer toutes les statistiques
                const statsSnapshot = await db.collection('game_statistics').get();
                const statsBatch = db.batch();
                
                statsSnapshot.docs.forEach(doc => {
                    statsBatch.delete(doc.ref);
                });
                
                await statsBatch.commit();
                log(`‚úÖ ${statsSnapshot.docs.length} statistiques supprim√©es`, 'success', 'reset-log');
                
                log('‚úÖ Reset complet termin√©', 'success', 'reset-log');
                log('üìù Relancez la correction compl√®te pour recr√©er les donn√©es', 'info', 'reset-log');
                
            } catch (error) {
                log(`‚ùå Erreur reset: ${error.message}`, 'error', 'reset-log');
            }
        }

        // Auto-initialisation
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Page de correction compl√®te charg√©e', 'info');
            log('üìù Cliquez sur "Lancer la Correction Compl√®te" pour commencer', 'info');
        });
    </script>
</body>
</html> 