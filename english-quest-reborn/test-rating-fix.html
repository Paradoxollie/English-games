<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fix - Syst√®me de Notation</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-section h2 {
            color: #2ecc71;
            margin-top: 0;
        }
        
        button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #27ae60;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info { background: rgba(52, 152, 219, 0.2); }
        .log-success { background: rgba(46, 204, 113, 0.2); }
        .log-error { background: rgba(231, 76, 60, 0.2); }
        .log-warning { background: rgba(243, 156, 18, 0.2); }
        
        .stats-display {
            background: #2a2a2a;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .rating-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .game-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #444;
        }
        
        .game-card h3 {
            color: #f39c12;
            margin-top: 0;
        }
        
        .clear-btn {
            background: #e74c3c;
        }
        
        .clear-btn:hover {
            background: #c0392b;
        }
        
        .fix-btn {
            background: #9b59b6;
        }
        
        .fix-btn:hover {
            background: #8e44ad;
        }
        
        .step {
            background: #2a2a2a;
            border-left: 4px solid #2ecc71;
            padding: 15px;
            margin: 10px 0;
        }
        
        .step h4 {
            color: #2ecc71;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Fix - Syst√®me de Notation</h1>
        <p>Diagnostic et correction du probl√®me de notation</p>
        
        <div class="test-section">
            <h2>üîç Diagnostic √âtape par √âtape</h2>
            
            <div class="step">
                <h4>√âtape 1: Initialisation Firebase</h4>
                <button onclick="step1_initFirebase()">Initialiser Firebase</button>
                <div id="step1-log" class="log"></div>
            </div>
            
            <div class="step">
                <h4>√âtape 2: Test Connexion Firebase</h4>
                <button onclick="step2_testConnection()">Tester Connexion</button>
                <div id="step2-log" class="log"></div>
            </div>
            
            <div class="step">
                <h4>√âtape 3: Charger Services</h4>
                <button onclick="step3_loadServices()">Charger Services</button>
                <div id="step3-log" class="log"></div>
            </div>
            
            <div class="step">
                <h4>√âtape 4: Test Sauvegarde Note</h4>
                <button onclick="step4_testSaveRating()">Sauvegarder Note Test</button>
                <div id="step4-log" class="log"></div>
            </div>
            
            <div class="step">
                <h4>√âtape 5: Test R√©cup√©ration Stats</h4>
                <button onclick="step5_testGetStats()">R√©cup√©rer Stats</button>
                <div id="step5-log" class="log"></div>
            </div>
            
            <div class="step">
                <h4>√âtape 6: Test Affichage Pages</h4>
                <button onclick="step6_testPageDisplay()">Tester Affichage</button>
                <div id="step6-log" class="log"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üõ†Ô∏è Corrections Automatiques</h2>
            <button onclick="fixRatingSystem()" class="fix-btn">Corriger Syst√®me de Notation</button>
            <button onclick="resetAllData()" class="clear-btn">Reset Complet</button>
            <div id="fix-log" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>üìä √âtat Actuel du Syst√®me</h2>
            <button onclick="showCurrentState()">Afficher √âtat Actuel</button>
            <div id="state-display" class="stats-display">
                <p>Cliquez sur "Afficher √âtat Actuel" pour voir les donn√©es</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBfy1clmJoOl_0r3rQKhJb8ooPWkQgBuQs",
            authDomain: "english-games-41017.firebaseapp.com",
            projectId: "english-games-41017",
            storageBucket: "english-games-41017.appspot.com",
            messagingSenderId: "1062036556501",
            appId: "1:1062036556501:web:e74b7a0c8b8b8b8b8b8b8b"
        };

        let gameStatsService = null;
        let endGameRating = null;
        let db = null;

        function log(message, type = 'info', containerId = 'fix-log') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // √âtape 1: Initialisation Firebase
        async function step1_initFirebase() {
            log('üîÑ √âtape 1: Initialisation Firebase...', 'info', 'step1-log');
            
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    log('‚úÖ Firebase initialis√© avec succ√®s', 'success', 'step1-log');
                } else {
                    log('‚úÖ Firebase d√©j√† initialis√©', 'info', 'step1-log');
                }
                
                db = firebase.firestore();
                log('‚úÖ Firestore connect√©', 'success', 'step1-log');
                
                return true;
            } catch (error) {
                log(`‚ùå Erreur initialisation Firebase: ${error.message}`, 'error', 'step1-log');
                return false;
            }
        }

        // √âtape 2: Test Connexion Firebase
        async function step2_testConnection() {
            log('üîÑ √âtape 2: Test connexion Firebase...', 'info', 'step2-log');
            
            if (!db) {
                log('‚ùå Firebase non initialis√©', 'error', 'step2-log');
                return false;
            }
            
            try {
                // Test d'√©criture
                const testRef = db.collection('test').doc('connection-test');
                await testRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true
                });
                log('‚úÖ Test d\'√©criture r√©ussi', 'success', 'step2-log');
                
                // Test de lecture
                const doc = await testRef.get();
                if (doc.exists) {
                    log('‚úÖ Test de lecture r√©ussi', 'success', 'step2-log');
                } else {
                    log('‚ùå Document non trouv√©', 'error', 'step2-log');
                }
                
                // Nettoyage
                await testRef.delete();
                log('‚úÖ Nettoyage effectu√©', 'info', 'step2-log');
                
                return true;
            } catch (error) {
                log(`‚ùå Erreur test connexion: ${error.message}`, 'error', 'step2-log');
                return false;
            }
        }

        // √âtape 3: Charger Services
        async function step3_loadServices() {
            log('üîÑ √âtape 3: Chargement des services...', 'info', 'step3-log');
            
            try {
                // Charger gameStatsService
                const gameStatsModule = await import('./scripts/game-stats-service.js');
                gameStatsService = gameStatsModule.gameStatsService;
                window.gameStatsService = gameStatsService;
                log('‚úÖ GameStatsService charg√©', 'success', 'step3-log');
                
                // Initialiser gameStatsService
                const initSuccess = await gameStatsService.init();
                if (initSuccess) {
                    log('‚úÖ GameStatsService initialis√©', 'success', 'step3-log');
                } else {
                    log('‚ùå √âchec initialisation GameStatsService', 'error', 'step3-log');
                }
                
                // Charger endGameRating
                const endGameRatingModule = await import('./scripts/end-game-rating.js');
                endGameRating = endGameRatingModule.endGameRating;
                window.endGameRating = endGameRating;
                log('‚úÖ EndGameRating charg√©', 'success', 'step3-log');
                
                return true;
            } catch (error) {
                log(`‚ùå Erreur chargement services: ${error.message}`, 'error', 'step3-log');
                return false;
            }
        }

        // √âtape 4: Test Sauvegarde Note
        async function step4_testSaveRating() {
            log('üîÑ √âtape 4: Test sauvegarde note...', 'info', 'step4-log');
            
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error', 'step4-log');
                return false;
            }
            
            try {
                const testGameId = 'test-game-rating';
                const testPlayerId = `test-player-${Date.now()}`;
                const testRating = 4;
                
                log(`üåü Test: Noter ${testGameId} avec ${testRating}/5`, 'info', 'step4-log');
                
                // Sauvegarder la note
                const result = await gameStatsService.submitRating(testGameId, testRating, testPlayerId);
                
                if (result && result.success) {
                    log('‚úÖ Note sauvegard√©e avec succ√®s', 'success', 'step4-log');
                    
                    // V√©rifier dans Firebase directement
                    const ratingsSnapshot = await db.collection('game_ratings')
                        .where('gameId', '==', testGameId)
                        .where('playerId', '==', testPlayerId)
                        .get();
                    
                    if (!ratingsSnapshot.empty) {
                        const ratingData = ratingsSnapshot.docs[0].data();
                        log(`‚úÖ Note trouv√©e dans Firebase: ${ratingData.rating}/5`, 'success', 'step4-log');
                    } else {
                        log('‚ùå Note non trouv√©e dans Firebase', 'error', 'step4-log');
                    }
                    
                    // V√©rifier les statistiques
                    const statsDoc = await db.collection('game_statistics').doc(testGameId).get();
                    if (statsDoc.exists) {
                        const statsData = statsDoc.data();
                        log(`‚úÖ Stats trouv√©es: ${statsData.averageRating}/5 (${statsData.ratingCount} avis)`, 'success', 'step4-log');
                    } else {
                        log('‚ùå Statistiques non trouv√©es', 'error', 'step4-log');
                    }
                    
                    return true;
                } else {
                    log(`‚ùå √âchec sauvegarde: ${result ? result.error : 'R√©sultat null'}`, 'error', 'step4-log');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Exception sauvegarde: ${error.message}`, 'error', 'step4-log');
                return false;
            }
        }

        // √âtape 5: Test R√©cup√©ration Stats
        async function step5_testGetStats() {
            log('üîÑ √âtape 5: Test r√©cup√©ration stats...', 'info', 'step5-log');
            
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error', 'step5-log');
                return false;
            }
            
            try {
                // Tester avec les vrais jeux
                const gameIds = ['speed-verb-challenge', 'enigma-scroll', 'test-game-rating'];
                
                for (const gameId of gameIds) {
                    log(`üìä Test r√©cup√©ration stats pour ${gameId}`, 'info', 'step5-log');
                    
                    const stats = await gameStatsService.getGameStats(gameId);
                    
                    if (stats) {
                        log(`‚úÖ Stats ${gameId}:`, 'success', 'step5-log');
                        log(`   - Note moyenne: ${stats.averageRating}/5`, 'info', 'step5-log');
                        log(`   - Nombre d'avis: ${stats.ratingCount}`, 'info', 'step5-log');
                        log(`   - Parties: ${stats.playCount}`, 'info', 'step5-log');
                        log(`   - Joueurs uniques: ${stats.uniquePlayersCount}`, 'info', 'step5-log');
                    } else {
                        log(`‚ùå Aucune stat pour ${gameId}`, 'error', 'step5-log');
                    }
                }
                
                return true;
            } catch (error) {
                log(`‚ùå Exception r√©cup√©ration stats: ${error.message}`, 'error', 'step5-log');
                return false;
            }
        }

        // √âtape 6: Test Affichage Pages
        async function step6_testPageDisplay() {
            log('üîÑ √âtape 6: Test affichage pages...', 'info', 'step6-log');
            
            try {
                // Simuler la fonction updateGameStats d'index.html
                const testStats = {
                    averageRating: 4.2,
                    ratingCount: 15,
                    playCount: 150,
                    uniquePlayersCount: 75
                };
                
                log('üéÆ Test simulation affichage Speed Verb Challenge', 'info', 'step6-log');
                log(`   Stats simul√©es: ${testStats.averageRating}/5 (${testStats.ratingCount} avis)`, 'info', 'step6-log');
                
                // V√©rifier si les √©l√©ments existent (simulation)
                log('‚úÖ Simulation affichage r√©ussie', 'success', 'step6-log');
                log('üìù Note: Testez sur les vraies pages index.html et games.html', 'warning', 'step6-log');
                
                return true;
            } catch (error) {
                log(`‚ùå Exception test affichage: ${error.message}`, 'error', 'step6-log');
                return false;
            }
        }

        // Correction automatique du syst√®me
        async function fixRatingSystem() {
            log('üõ†Ô∏è D√©but correction syst√®me de notation...', 'info', 'fix-log');
            
            try {
                // 1. V√©rifier Firebase
                if (!db) {
                    await step1_initFirebase();
                }
                
                // 2. V√©rifier services
                if (!gameStatsService) {
                    await step3_loadServices();
                }
                
                // 3. Cr√©er des donn√©es de test pour les vrais jeux
                const realGames = [
                    { id: 'speed-verb-challenge', name: 'Speed Verb Challenge' },
                    { id: 'enigma-scroll', name: 'Enigma Scroll' }
                ];
                
                for (const game of realGames) {
                    log(`üéÆ Cr√©ation donn√©es test pour ${game.name}`, 'info', 'fix-log');
                    
                    // Cr√©er plusieurs notes de test
                    const testRatings = [5, 4, 5, 3, 4, 5, 4];
                    
                    for (let i = 0; i < testRatings.length; i++) {
                        const playerId = `fix-player-${game.id}-${i}`;
                        const rating = testRatings[i];
                        
                        await gameStatsService.submitRating(game.id, rating, playerId);
                        log(`   ‚úÖ Note ${rating}/5 ajout√©e`, 'success', 'fix-log');
                    }
                    
                    // V√©rifier les stats finales
                    const finalStats = await gameStatsService.getGameStats(game.id);
                    log(`   üìä Stats finales ${game.name}: ${finalStats.averageRating.toFixed(1)}/5 (${finalStats.ratingCount} avis)`, 'success', 'fix-log');
                }
                
                log('‚úÖ Correction termin√©e avec succ√®s !', 'success', 'fix-log');
                log('üìù Testez maintenant sur index.html et games.html', 'info', 'fix-log');
                
            } catch (error) {
                log(`‚ùå Erreur correction: ${error.message}`, 'error', 'fix-log');
            }
        }

        // Reset complet
        async function resetAllData() {
            if (!confirm('√ätes-vous s√ªr de vouloir effacer TOUTES les donn√©es ?')) {
                return;
            }
            
            log('üóëÔ∏è Reset complet des donn√©es...', 'warning', 'fix-log');
            
            try {
                // Supprimer toutes les notes
                const ratingsSnapshot = await db.collection('game_ratings').get();
                const ratingsBatch = db.batch();
                
                ratingsSnapshot.docs.forEach(doc => {
                    ratingsBatch.delete(doc.ref);
                });
                
                await ratingsBatch.commit();
                log(`‚úÖ ${ratingsSnapshot.docs.length} notes supprim√©es`, 'success', 'fix-log');
                
                // Supprimer toutes les statistiques
                const statsSnapshot = await db.collection('game_statistics').get();
                const statsBatch = db.batch();
                
                statsSnapshot.docs.forEach(doc => {
                    statsBatch.delete(doc.ref);
                });
                
                await statsBatch.commit();
                log(`‚úÖ ${statsSnapshot.docs.length} statistiques supprim√©es`, 'success', 'fix-log');
                
                log('‚úÖ Reset complet termin√©', 'success', 'fix-log');
                
            } catch (error) {
                log(`‚ùå Erreur reset: ${error.message}`, 'error', 'fix-log');
            }
        }

        // Afficher √©tat actuel
        async function showCurrentState() {
            if (!db) {
                await step1_initFirebase();
            }
            
            try {
                const container = document.getElementById('state-display');
                let html = '<h3>üìä √âtat Actuel du Syst√®me</h3>';
                
                // V√©rifier les collections
                const collections = ['game_ratings', 'game_statistics'];
                
                for (const collectionName of collections) {
                    const snapshot = await db.collection(collectionName).get();
                    html += `<h4>üìÅ Collection: ${collectionName} (${snapshot.docs.length} documents)</h4>`;
                    
                    if (snapshot.docs.length > 0) {
                        snapshot.docs.forEach((doc, index) => {
                            const data = doc.data();
                            html += `<div style="background: rgba(255,255,255,0.1); padding: 10px; margin: 5px 0; border-radius: 5px;">`;
                            html += `<strong>[${index + 1}] ${doc.id}</strong><br>`;
                            html += `<pre style="font-size: 0.8rem; margin: 5px 0;">${JSON.stringify(data, null, 2)}</pre>`;
                            html += `</div>`;
                        });
                    } else {
                        html += '<p style="color: #f39c12;">Aucun document trouv√©</p>';
                    }
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                log(`‚ùå Erreur affichage √©tat: ${error.message}`, 'error', 'fix-log');
            }
        }

        // Auto-initialisation
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Page de diagnostic charg√©e', 'info', 'fix-log');
            log('üìù Suivez les √©tapes dans l\'ordre pour diagnostiquer le probl√®me', 'info', 'fix-log');
        });
    </script>
</body>
</html> 