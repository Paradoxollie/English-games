<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notation Jeux R√©els - English Quest</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .section h2 {
            color: #2ecc71;
            margin-top: 0;
        }
        
        button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        
        button:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-primary {
            background: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info { background: rgba(52, 152, 219, 0.2); }
        .log-success { background: rgba(46, 204, 113, 0.2); }
        .log-error { background: rgba(231, 76, 60, 0.2); }
        .log-warning { background: rgba(243, 156, 18, 0.2); }
        
        .game-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .game-link {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #444;
            text-align: center;
        }
        
        .game-link h3 {
            color: #f39c12;
            margin-top: 0;
        }
        
        .game-link a {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin: 10px 5px;
        }
        
        .game-link a:hover {
            background: #2980b9;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status.online {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }
        
        .status.offline {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Test Notation dans les Jeux R√©els</h1>
        <p>V√©rification du syst√®me de notation dans Speed Verb Challenge et Enigma Scroll</p>
        
        <div class="section">
            <h2>üîç √âtat du Syst√®me</h2>
            <div id="system-status" class="status offline">
                <strong>√âtat Firebase:</strong> <span id="firebase-status">V√©rification...</span>
            </div>
            <div id="services-status" class="status offline">
                <strong>Services:</strong> <span id="services-text">Chargement...</span>
            </div>
            <button onclick="checkSystemStatus()">V√©rifier √âtat</button>
            <div id="status-log" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üéÆ Liens vers les Jeux</h2>
            <div class="game-links">
                <div class="game-link">
                    <h3>Speed Verb Challenge</h3>
                    <p>Testez le syst√®me de notation apr√®s avoir termin√© une partie</p>
                    <a href="games/speed-verb-challenge.html" target="_blank">Jouer</a>
                    <button onclick="simulateSpeedVerbEnd()">Simuler Fin de Partie</button>
                </div>
                
                <div class="game-link">
                    <h3>Enigma Scroll</h3>
                    <p>Testez le syst√®me de notation apr√®s avoir termin√© une partie</p>
                    <a href="games/enigma-scroll-main.html" target="_blank">Jouer</a>
                    <button onclick="simulateEnigmaEnd()">Simuler Fin de Partie</button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üß™ Tests de Notation</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <button onclick="testDirectRating('speed-verb-challenge')">Noter Speed Verb</button>
                <button onclick="testDirectRating('enigma-scroll')">Noter Enigma Scroll</button>
                <button onclick="checkExistingRatings()">V√©rifier Notes Existantes</button>
                <button onclick="testRatingUpdate()">Test Mise √† Jour Note</button>
            </div>
            <div id="test-log" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üìä Statistiques Actuelles</h2>
            <button onclick="showCurrentStats()">Afficher Stats</button>
            <div id="stats-display" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üõ†Ô∏è Outils de Debug</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <button onclick="clearBrowserCache()">Vider Cache Navigateur</button>
                <button onclick="resetFirebaseConnection()">Reset Connexion Firebase</button>
                <button onclick="testFirebaseWrite()">Test √âcriture Firebase</button>
                <button onclick="checkConsoleErrors()">V√©rifier Erreurs Console</button>
            </div>
            <div id="debug-log" class="log"></div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBfy1clmJoOl_0r3rQKhJb8ooPWkQgBuQs",
            authDomain: "english-games-41017.firebaseapp.com",
            projectId: "english-games-41017",
            storageBucket: "english-games-41017.appspot.com",
            messagingSenderId: "1062036556501",
            appId: "1:1062036556501:web:e74b7a0c8b8b8b8b8b8b8b"
        };

        let gameStatsService = null;
        let endGameRating = null;
        let db = null;

        function log(message, type = 'info', containerId = 'status-log') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function initializeSystem() {
            try {
                // Initialiser Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    log('‚úÖ Firebase initialis√©', 'success');
                } else {
                    log('‚úÖ Firebase d√©j√† initialis√©', 'info');
                }
                
                db = firebase.firestore();
                
                // Charger les services
                const gameStatsModule = await import('./scripts/game-stats-service.js');
                gameStatsService = gameStatsModule.gameStatsService;
                window.gameStatsService = gameStatsService;
                
                const endGameRatingModule = await import('./scripts/end-game-rating.js');
                endGameRating = endGameRatingModule.endGameRating;
                window.endGameRating = endGameRating;
                
                await gameStatsService.init();
                
                log('‚úÖ Services charg√©s et initialis√©s', 'success');
                updateSystemStatus();
                
            } catch (error) {
                log(`‚ùå Erreur initialisation: ${error.message}`, 'error');
                updateSystemStatus(false);
            }
        }

        function updateSystemStatus(isOnline = true) {
            const firebaseStatus = document.getElementById('firebase-status');
            const servicesStatus = document.getElementById('services-text');
            const systemStatusDiv = document.getElementById('system-status');
            const servicesStatusDiv = document.getElementById('services-status');
            
            if (isOnline && db && gameStatsService && endGameRating) {
                firebaseStatus.textContent = 'Connect√© ‚úÖ';
                servicesStatus.textContent = 'Charg√©s ‚úÖ';
                systemStatusDiv.className = 'status online';
                servicesStatusDiv.className = 'status online';
            } else {
                firebaseStatus.textContent = 'D√©connect√© ‚ùå';
                servicesStatus.textContent = 'Non disponibles ‚ùå';
                systemStatusDiv.className = 'status offline';
                servicesStatusDiv.className = 'status offline';
            }
        }

        async function checkSystemStatus() {
            log('üîç V√©rification de l\'√©tat du syst√®me...', 'info', 'status-log');
            
            try {
                // Test Firebase
                if (db) {
                    const testDoc = await db.collection('_test').doc('connection').set({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        test: true
                    });
                    log('‚úÖ Firebase: √âcriture OK', 'success', 'status-log');
                } else {
                    log('‚ùå Firebase: Non initialis√©', 'error', 'status-log');
                }
                
                // Test services
                if (gameStatsService && gameStatsService.isInitialized) {
                    log('‚úÖ GameStatsService: Initialis√©', 'success', 'status-log');
                } else {
                    log('‚ùå GameStatsService: Non disponible', 'error', 'status-log');
                }
                
                if (endGameRating) {
                    log('‚úÖ EndGameRating: Disponible', 'success', 'status-log');
                } else {
                    log('‚ùå EndGameRating: Non disponible', 'error', 'status-log');
                }
                
                updateSystemStatus();
                
            } catch (error) {
                log(`‚ùå Erreur v√©rification: ${error.message}`, 'error', 'status-log');
                updateSystemStatus(false);
            }
        }

        async function testDirectRating(gameId) {
            log(`üåü Test notation directe pour ${gameId}...`, 'info', 'test-log');
            
            if (!endGameRating) {
                log('‚ùå Service endGameRating non disponible', 'error', 'test-log');
                return;
            }
            
            const playerId = `test-${gameId}-${Date.now()}`;
            const gameTitle = gameId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            endGameRating.showRating(gameId, playerId, gameTitle);
            log(`‚úÖ Interface de notation affich√©e pour ${gameTitle}`, 'success', 'test-log');
        }

        async function simulateSpeedVerbEnd() {
            log('üéÆ Simulation fin de partie Speed Verb Challenge...', 'info', 'test-log');
            
            // Simuler les variables d'un jeu termin√©
            const gameData = {
                score: 150,
                level: 4,
                verbsCompleted: 12,
                difficulty: 2
            };
            
            const playerId = `sim-speed-${Date.now()}`;
            
            // Enregistrer les stats de jeu
            if (gameStatsService) {
                await gameStatsService.recordGamePlay('speed-verb-challenge', playerId, gameData.score);
                log('üìä Stats de jeu enregistr√©es', 'success', 'test-log');
            }
            
            // Afficher l'interface de notation apr√®s 2 secondes
            setTimeout(() => {
                if (endGameRating) {
                    endGameRating.showRating('speed-verb-challenge', playerId, 'Speed Verb Challenge');
                    log('üåü Interface de notation affich√©e', 'success', 'test-log');
                } else {
                    log('‚ùå Service endGameRating non disponible', 'error', 'test-log');
                }
            }, 2000);
        }

        async function simulateEnigmaEnd() {
            log('üéÆ Simulation fin de partie Enigma Scroll...', 'info', 'test-log');
            
            const gameData = {
                score: 200,
                attempts: 4,
                timeElapsed: 180,
                difficulty: 'normal'
            };
            
            const playerId = `sim-enigma-${Date.now()}`;
            
            // Enregistrer les stats de jeu
            if (gameStatsService) {
                await gameStatsService.recordGamePlay('enigma-scroll', playerId, gameData.score);
                log('üìä Stats de jeu enregistr√©es', 'success', 'test-log');
            }
            
            // Afficher l'interface de notation apr√®s 2 secondes
            setTimeout(() => {
                if (endGameRating) {
                    endGameRating.showRating('enigma-scroll', playerId, 'Enigma Scroll');
                    log('üåü Interface de notation affich√©e', 'success', 'test-log');
                } else {
                    log('‚ùå Service endGameRating non disponible', 'error', 'test-log');
                }
            }, 2000);
        }

        async function checkExistingRatings() {
            log('üìä V√©rification des notes existantes...', 'info', 'test-log');
            
            if (!db) {
                log('‚ùå Firebase non disponible', 'error', 'test-log');
                return;
            }
            
            try {
                const ratingsSnapshot = await db.collection('game_ratings').get();
                const statsSnapshot = await db.collection('game_statistics').get();
                
                log(`üìÅ ${ratingsSnapshot.docs.length} notes trouv√©es`, 'info', 'test-log');
                log(`üìÅ ${statsSnapshot.docs.length} jeux avec stats`, 'info', 'test-log');
                
                // Afficher quelques exemples
                ratingsSnapshot.docs.slice(0, 3).forEach((doc, index) => {
                    const data = doc.data();
                    log(`   [${index + 1}] ${data.gameId}: ${data.rating}/5 par ${data.playerId}`, 'info', 'test-log');
                });
                
            } catch (error) {
                log(`‚ùå Erreur v√©rification: ${error.message}`, 'error', 'test-log');
            }
        }

        async function testRatingUpdate() {
            log('üîÑ Test mise √† jour de note...', 'info', 'test-log');
            
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error', 'test-log');
                return;
            }
            
            try {
                const testGameId = 'test-update-rating';
                const testPlayerId = `update-test-${Date.now()}`;
                
                // Premi√®re note
                await gameStatsService.submitRating(testGameId, 3, testPlayerId);
                log('‚úÖ Premi√®re note (3/5) soumise', 'success', 'test-log');
                
                // Attendre un peu
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Deuxi√®me note (mise √† jour)
                await gameStatsService.submitRating(testGameId, 5, testPlayerId);
                log('‚úÖ Note mise √† jour (5/5)', 'success', 'test-log');
                
                // V√©rifier les stats finales
                const stats = await gameStatsService.getGameStats(testGameId);
                log(`üìä Stats finales: ${stats.averageRating}/5 (${stats.ratingCount} avis)`, 'info', 'test-log');
                
            } catch (error) {
                log(`‚ùå Erreur test mise √† jour: ${error.message}`, 'error', 'test-log');
            }
        }

        async function showCurrentStats() {
            log('üìä R√©cup√©ration des statistiques actuelles...', 'info', 'stats-display');
            
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error', 'stats-display');
                return;
            }
            
            try {
                const games = ['speed-verb-challenge', 'enigma-scroll', 'word-memory-game', 'memory-matrix'];
                
                for (const gameId of games) {
                    const stats = await gameStatsService.getGameStats(gameId);
                    const gameName = gameId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    log(`üéÆ ${gameName}:`, 'info', 'stats-display');
                    log(`   üìä Note: ${stats.averageRating}/5 (${stats.ratingCount} avis)`, 'info', 'stats-display');
                    log(`   üë• Joueurs: ${stats.uniquePlayersCount} uniques, ${stats.playCount} parties`, 'info', 'stats-display');
                    log(`   üè∑Ô∏è Type: ${stats.isDefault ? 'Valeurs par d√©faut' : 'Donn√©es r√©elles'}`, 'info', 'stats-display');
                }
                
            } catch (error) {
                log(`‚ùå Erreur r√©cup√©ration stats: ${error.message}`, 'error', 'stats-display');
            }
        }

        async function clearBrowserCache() {
            log('üóëÔ∏è Nettoyage du cache navigateur...', 'info', 'debug-log');
            
            try {
                // Vider le localStorage
                localStorage.clear();
                log('‚úÖ localStorage vid√©', 'success', 'debug-log');
                
                // Vider le sessionStorage
                sessionStorage.clear();
                log('‚úÖ sessionStorage vid√©', 'success', 'debug-log');
                
                // Recharger la page
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Erreur nettoyage: ${error.message}`, 'error', 'debug-log');
            }
        }

        async function resetFirebaseConnection() {
            log('üîÑ Reset connexion Firebase...', 'info', 'debug-log');
            
            try {
                // R√©initialiser Firebase
                if (firebase.apps.length > 0) {
                    await firebase.app().delete();
                    log('‚úÖ Firebase d√©connect√©', 'success', 'debug-log');
                }
                
                // R√©initialiser
                await initializeSystem();
                log('‚úÖ Firebase reconnect√©', 'success', 'debug-log');
                
            } catch (error) {
                log(`‚ùå Erreur reset: ${error.message}`, 'error', 'debug-log');
            }
        }

        async function testFirebaseWrite() {
            log('‚úçÔ∏è Test √©criture Firebase...', 'info', 'debug-log');
            
            if (!db) {
                log('‚ùå Firebase non initialis√©', 'error', 'debug-log');
                return;
            }
            
            try {
                const testData = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: 'write-test',
                    value: Math.random()
                };
                
                const docRef = await db.collection('_debug_test').add(testData);
                log(`‚úÖ √âcriture r√©ussie: ${docRef.id}`, 'success', 'debug-log');
                
                // Lire pour v√©rifier
                const doc = await docRef.get();
                if (doc.exists) {
                    log('‚úÖ Lecture de v√©rification r√©ussie', 'success', 'debug-log');
                } else {
                    log('‚ùå Document non trouv√© apr√®s √©criture', 'error', 'debug-log');
                }
                
            } catch (error) {
                log(`‚ùå Erreur √©criture: ${error.message}`, 'error', 'debug-log');
                
                // Analyser l'erreur
                if (error.code === 'permission-denied') {
                    log('üîí Erreur de permissions Firebase', 'warning', 'debug-log');
                } else if (error.code === 'unavailable') {
                    log('üåê Firebase indisponible (probl√®me r√©seau)', 'warning', 'debug-log');
                } else {
                    log(`üîç Code d'erreur: ${error.code}`, 'info', 'debug-log');
                }
            }
        }

        function checkConsoleErrors() {
            log('üîç V√©rification des erreurs console...', 'info', 'debug-log');
            
            // Capturer les erreurs console
            const originalError = console.error;
            const errors = [];
            
            console.error = function(...args) {
                errors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            // Attendre un peu pour capturer les erreurs
            setTimeout(() => {
                console.error = originalError;
                
                if (errors.length > 0) {
                    log(`‚ùå ${errors.length} erreurs d√©tect√©es:`, 'error', 'debug-log');
                    errors.forEach((error, index) => {
                        log(`   [${index + 1}] ${error}`, 'error', 'debug-log');
                    });
                } else {
                    log('‚úÖ Aucune erreur console d√©tect√©e', 'success', 'debug-log');
                }
            }, 2000);
        }

        // Initialisation automatique
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Page de test charg√©e', 'info');
            initializeSystem();
        });

        // √âcouter les √©v√©nements de notation
        window.addEventListener('gameRatingUpdated', (event) => {
            log(`üåü √âv√©nement de notation re√ßu: ${event.detail.gameId}`, 'success', 'test-log');
        });
    </script>
</body>
</html> 