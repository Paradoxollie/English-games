<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Debug Syst√®me de Notation</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-section h2 {
            color: #2ecc71;
            margin-top: 0;
        }
        
        button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #27ae60;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info { background: rgba(52, 152, 219, 0.2); }
        .log-success { background: rgba(46, 204, 113, 0.2); }
        .log-error { background: rgba(231, 76, 60, 0.2); }
        .log-warning { background: rgba(243, 156, 18, 0.2); }
        
        .stats-display {
            background: #2a2a2a;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .rating-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .game-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #444;
        }
        
        .game-card h3 {
            color: #f39c12;
            margin-top: 0;
        }
        
        .clear-btn {
            background: #e74c3c;
        }
        
        .clear-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Debug - Syst√®me de Notation</h1>
        
        <div class="test-section">
            <h2>üîß Initialisation des Services</h2>
            <button onclick="initServices()">Initialiser Firebase & Services</button>
            <button onclick="checkServices()">V√©rifier Services</button>
            <div id="init-status" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>üìù Tests de Notation</h2>
            <div class="rating-test">
                <div class="game-card">
                    <h3>Speed Verb Challenge</h3>
                    <button onclick="testRating('speed-verb-challenge', 5)">Noter 5/5</button>
                    <button onclick="testRating('speed-verb-challenge', 3)">Noter 3/5</button>
                    <button onclick="showRatingModal('speed-verb-challenge')">Afficher Modal</button>
                    <button onclick="getGameStats('speed-verb-challenge')" style="background: #3498db;">Voir Stats</button>
                </div>
                
                <div class="game-card">
                    <h3>Enigma Scroll</h3>
                    <button onclick="testRating('enigma-scroll', 4)">Noter 4/5</button>
                    <button onclick="testRating('enigma-scroll', 2)">Noter 2/5</button>
                    <button onclick="showRatingModal('enigma-scroll')">Afficher Modal</button>
                    <button onclick="getGameStats('enigma-scroll')" style="background: #3498db;">Voir Stats</button>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <button onclick="getAllStats()" style="background: #9b59b6;">R√©cup√©rer Toutes les Stats</button>
                <button onclick="clearAllRatings()" class="clear-btn">Effacer Toutes les Notes</button>
            </div>
            
            <div id="rating-log" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>üìä Statistiques en Temps R√©el</h2>
            <div id="stats-display" class="stats-display">
                <p>Cliquez sur "R√©cup√©rer Toutes les Stats" pour voir les donn√©es</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîç Debug Firebase</h2>
            <button onclick="debugFirebase()">Inspecter Collections Firebase</button>
            <button onclick="testFirebaseConnection()">Test Connexion Firebase</button>
            <div id="firebase-debug" class="log"></div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBfy1clmJoOl_0r3rQKhJb8ooPWkQgBuQs",
            authDomain: "english-games-41017.firebaseapp.com",
            projectId: "english-games-41017",
            storageBucket: "english-games-41017.appspot.com",
            messagingSenderId: "1062036556501",
            appId: "1:1062036556501:web:e74b7a0c8b8b8b8b8b8b8b"
        };

        let gameStatsService = null;
        let endGameRating = null;

        function log(message, type = 'info', containerId = 'rating-log') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function initServices() {
            log('üîÑ Initialisation Firebase...', 'info', 'init-status');
            
            try {
                // Initialiser Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    log('‚úÖ Firebase initialis√©', 'success', 'init-status');
                } else {
                    log('‚úÖ Firebase d√©j√† initialis√©', 'info', 'init-status');
                }
                
                // Charger les services
                log('üîÑ Chargement des services...', 'info', 'init-status');
                
                // Importer les services
                const gameStatsModule = await import('./scripts/game-stats-service.js');
                const endGameRatingModule = await import('./scripts/end-game-rating.js');
                
                gameStatsService = gameStatsModule.gameStatsService;
                endGameRating = endGameRatingModule.endGameRating;
                
                // Rendre disponibles globalement
                window.gameStatsService = gameStatsService;
                window.endGameRating = endGameRating;
                
                // Initialiser gameStatsService
                const initSuccess = await gameStatsService.init();
                if (initSuccess) {
                    log('‚úÖ GameStatsService initialis√©', 'success', 'init-status');
                } else {
                    log('‚ùå √âchec initialisation GameStatsService', 'error', 'init-status');
                }
                
                log('‚úÖ Tous les services charg√©s', 'success', 'init-status');
                
            } catch (error) {
                log(`‚ùå Erreur initialisation: ${error.message}`, 'error', 'init-status');
                console.error('Erreur initialisation:', error);
            }
        }

        function checkServices() {
            log('üîç V√©rification des services...', 'info', 'init-status');
            
            const checks = [
                { name: 'Firebase', available: typeof firebase !== 'undefined' },
                { name: 'Firestore', available: firebase && firebase.firestore },
                { name: 'GameStatsService', available: !!gameStatsService },
                { name: 'EndGameRating', available: !!endGameRating },
                { name: 'GameStatsService.isInitialized', available: gameStatsService && gameStatsService.isInitialized }
            ];
            
            checks.forEach(check => {
                const status = check.available ? '‚úÖ' : '‚ùå';
                const type = check.available ? 'success' : 'error';
                log(`${status} ${check.name}`, type, 'init-status');
            });
        }

        async function testRating(gameId, rating) {
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error');
                return;
            }
            
            log(`üåü Test notation ${gameId}: ${rating}/5`, 'info');
            
            try {
                const playerId = `test-player-${Date.now()}`;
                const result = await gameStatsService.submitRating(gameId, rating, playerId);
                
                if (result.success) {
                    const message = result.isUpdate 
                        ? `‚úÖ Note mise √† jour: ${rating}/5` 
                        : `‚úÖ Nouvelle note: ${rating}/5`;
                    log(message, 'success');
                    
                    // R√©cup√©rer les stats mises √† jour
                    setTimeout(() => getGameStats(gameId), 1000);
                } else {
                    log(`‚ùå Erreur notation: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Exception notation: ${error.message}`, 'error');
            }
        }

        async function showRatingModal(gameId) {
            if (!endGameRating) {
                log('‚ùå EndGameRating non disponible', 'error');
                return;
            }
            
            log(`üé≠ Affichage modal pour ${gameId}`, 'info');
            
            try {
                const playerId = `test-player-modal`;
                endGameRating.showRating(gameId, playerId, gameId.replace('-', ' ').toUpperCase());
                log('‚úÖ Modal affich√©e', 'success');
            } catch (error) {
                log(`‚ùå Erreur modal: ${error.message}`, 'error');
            }
        }

        async function getGameStats(gameId) {
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error');
                return;
            }
            
            log(`üìä R√©cup√©ration stats ${gameId}`, 'info');
            
            try {
                const stats = await gameStatsService.getGameStats(gameId);
                log(`üìà Stats ${gameId}:`, 'info');
                log(`   - Note moyenne: ${stats.averageRating}/5`, 'info');
                log(`   - Nombre d'avis: ${stats.ratingCount}`, 'info');
                log(`   - Parties jou√©es: ${stats.playCount}`, 'info');
                log(`   - Joueurs uniques: ${stats.uniquePlayersCount}`, 'info');
                
                updateStatsDisplay(gameId, stats);
            } catch (error) {
                log(`‚ùå Erreur r√©cup√©ration stats: ${error.message}`, 'error');
            }
        }

        async function getAllStats() {
            if (!gameStatsService) {
                log('‚ùå GameStatsService non disponible', 'error');
                return;
            }
            
            log('üìä R√©cup√©ration de toutes les statistiques...', 'info');
            
            try {
                const allStats = await gameStatsService.getAllGameStats();
                log('‚úÖ Toutes les stats r√©cup√©r√©es', 'success');
                
                const statsContainer = document.getElementById('stats-display');
                let html = '<h3>üìä Statistiques Compl√®tes</h3>';
                
                for (const [gameId, stats] of Object.entries(allStats)) {
                    html += `
                        <div class="stats-item">
                            <strong>${gameId}</strong>
                            <span>
                                ${stats.averageRating.toFixed(1)}/5 ‚≠ê 
                                (${stats.ratingCount} avis) | 
                                ${stats.uniquePlayersCount} joueurs | 
                                ${stats.playCount} parties
                            </span>
                        </div>
                    `;
                }
                
                if (Object.keys(allStats).length === 0) {
                    html += '<p>Aucune statistique trouv√©e</p>';
                }
                
                statsContainer.innerHTML = html;
                
            } catch (error) {
                log(`‚ùå Erreur r√©cup√©ration toutes stats: ${error.message}`, 'error');
            }
        }

        function updateStatsDisplay(gameId, stats) {
            const statsContainer = document.getElementById('stats-display');
            const existingItem = document.querySelector(`[data-game-id="${gameId}"]`);
            
            const statsHtml = `
                <div class="stats-item" data-game-id="${gameId}">
                    <strong>${gameId}</strong>
                    <span>
                        ${stats.averageRating.toFixed(1)}/5 ‚≠ê 
                        (${stats.ratingCount} avis) | 
                        ${stats.uniquePlayersCount} joueurs | 
                        ${stats.playCount} parties
                    </span>
                </div>
            `;
            
            if (existingItem) {
                existingItem.outerHTML = statsHtml;
            } else {
                statsContainer.insertAdjacentHTML('beforeend', statsHtml);
            }
        }

        async function clearAllRatings() {
            if (!confirm('√ätes-vous s√ªr de vouloir effacer toutes les notes ?')) {
                return;
            }
            
            log('üóëÔ∏è Suppression de toutes les notes...', 'warning');
            
            try {
                const db = firebase.firestore();
                
                // Supprimer toutes les notes
                const ratingsSnapshot = await db.collection('game_ratings').get();
                const batch = db.batch();
                
                ratingsSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                log(`‚úÖ ${ratingsSnapshot.docs.length} notes supprim√©es`, 'success');
                
                // R√©initialiser les stats
                const statsSnapshot = await db.collection('game_statistics').get();
                const statsBatch = db.batch();
                
                statsSnapshot.docs.forEach(doc => {
                    statsBatch.update(doc.ref, {
                        averageRating: 0,
                        ratingCount: 0
                    });
                });
                
                await statsBatch.commit();
                log('‚úÖ Statistiques r√©initialis√©es', 'success');
                
                // Rafra√Æchir l'affichage
                setTimeout(() => getAllStats(), 1000);
                
            } catch (error) {
                log(`‚ùå Erreur suppression: ${error.message}`, 'error');
            }
        }

        async function debugFirebase() {
            log('üîç Debug Firebase...', 'info', 'firebase-debug');
            
            try {
                const db = firebase.firestore();
                
                // V√©rifier les collections
                const collections = ['game_ratings', 'game_statistics'];
                
                for (const collectionName of collections) {
                    log(`üìÅ Collection: ${collectionName}`, 'info', 'firebase-debug');
                    
                    const snapshot = await db.collection(collectionName).limit(10).get();
                    log(`   üìÑ Documents: ${snapshot.docs.length}`, 'info', 'firebase-debug');
                    
                    snapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        log(`   [${index + 1}] ${doc.id}: ${JSON.stringify(data, null, 2)}`, 'info', 'firebase-debug');
                    });
                }
                
            } catch (error) {
                log(`‚ùå Erreur debug Firebase: ${error.message}`, 'error', 'firebase-debug');
            }
        }

        async function testFirebaseConnection() {
            log('üîó Test connexion Firebase...', 'info', 'firebase-debug');
            
            try {
                const db = firebase.firestore();
                const testDoc = await db.collection('test').doc('connection').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true
                });
                
                log('‚úÖ Connexion Firebase OK', 'success', 'firebase-debug');
                
                // Nettoyer
                await db.collection('test').doc('connection').delete();
                log('‚úÖ Document test supprim√©', 'info', 'firebase-debug');
                
            } catch (error) {
                log(`‚ùå Erreur connexion Firebase: ${error.message}`, 'error', 'firebase-debug');
            }
        }

        // Auto-initialisation
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Page de test charg√©e', 'info', 'init-status');
            setTimeout(() => initServices(), 500);
        });
    </script>
</body>
</html> 