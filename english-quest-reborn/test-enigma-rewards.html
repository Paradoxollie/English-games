<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test R√©compenses Enigma Scroll</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background-color: #27ae60;
        }
        .test-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .log-area {
            background-color: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success { background-color: #27ae60; }
        .status.error { background-color: #e74c3c; }
        .status.warning { background-color: #f39c12; }
        .status.info { background-color: #3498db; }
        .score-input {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üéÆ Test Syst√®me de R√©compenses Enigma Scroll</h1>
    
    <div class="test-section">
        <h2>üìä √âtat du Syst√®me</h2>
        <div id="system-status">V√©rification en cours...</div>
        <button class="test-button" onclick="checkSystemStatus()">üîÑ V√©rifier l'√©tat</button>
    </div>

    <div class="test-section">
        <h2>üèÜ Test V√©rification Top Score</h2>
        <p>Teste la fonction checkIfTopScore avec diff√©rents scores :</p>
        <input type="number" id="test-score" class="score-input" placeholder="Score √† tester" value="100">
        <button class="test-button" onclick="testTopScore()">üéØ Tester Top Score</button>
        <div id="top-score-result"></div>
    </div>

    <div class="test-section">
        <h2>üéÅ Test Attribution R√©compenses</h2>
        <p>Teste l'attribution des r√©compenses :</p>
        <input type="number" id="reward-score" class="score-input" placeholder="Score pour r√©compenses" value="150">
        <button class="test-button" onclick="testRewards(false)">üéÅ R√©compenses Normales</button>
        <button class="test-button" onclick="testRewards(true)">üèÜ R√©compenses Top Score</button>
        <div id="reward-result"></div>
    </div>

    <div class="test-section">
        <h2>üåê Test Scores En Ligne</h2>
        <p>Teste la r√©cup√©ration des scores en ligne :</p>
        <button class="test-button" onclick="testOnlineScores()">üì° R√©cup√©rer Scores En Ligne</button>
        <div id="online-scores-result"></div>
    </div>

    <div class="test-section">
        <h2>üìù Journal des Tests</h2>
        <button class="test-button" onclick="clearLog()">üóëÔ∏è Effacer</button>
        <div id="log" class="log-area"></div>
    </div>

    <!-- Inclure les scripts n√©cessaires -->
    <script type="module" src="src/js/services/auth.service.js"></script>
    <script src="scripts/reward-service.js"></script>
    <script src="src/js/enigma-scroll/enigma-scroll-firebase.js"></script>

    <script>
        let logElement;
        
        function log(message, type = 'info') {
            if (!logElement) logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Test] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function checkSystemStatus() {
            log('V√©rification de l\'√©tat du syst√®me...');
            const statusDiv = document.getElementById('system-status');
            let status = '';
            
            // V√©rifier authService
            if (window.authService) {
                status += '<div class="status success">‚úÖ AuthService disponible</div>';
                log('AuthService: OK');
            } else {
                status += '<div class="status error">‚ùå AuthService non disponible</div>';
                log('AuthService: MANQUANT', 'error');
            }
            
            // V√©rifier rewardService
            if (window.rewardService) {
                status += '<div class="status success">‚úÖ RewardService disponible</div>';
                log('RewardService: OK');
            } else {
                status += '<div class="status error">‚ùå RewardService non disponible</div>';
                log('RewardService: MANQUANT', 'error');
            }
            
            // V√©rifier EnigmaScrollFirebase
            if (window.EnigmaScrollFirebase) {
                if (window.EnigmaScrollFirebase.isAvailable) {
                    status += '<div class="status success">‚úÖ EnigmaScrollFirebase disponible</div>';
                    log('EnigmaScrollFirebase: OK');
                } else {
                    status += '<div class="status warning">‚ö†Ô∏è EnigmaScrollFirebase charg√© mais Firebase non disponible</div>';
                    log('EnigmaScrollFirebase: Firebase non disponible', 'warning');
                }
            } else {
                status += '<div class="status error">‚ùå EnigmaScrollFirebase non disponible</div>';
                log('EnigmaScrollFirebase: MANQUANT', 'error');
            }
            
            // V√©rifier l'authentification
            try {
                if (window.authService && window.authService.getAuthState) {
                    const authState = window.authService.getAuthState();
                    if (authState.isAuthenticated) {
                        status += '<div class="status success">‚úÖ Utilisateur connect√©: ' + (authState.profile.username || 'Anonyme') + '</div>';
                        log('Utilisateur connect√©: ' + (authState.profile.username || 'Anonyme'));
                    } else {
                        status += '<div class="status warning">‚ö†Ô∏è Utilisateur non connect√©</div>';
                        log('Utilisateur non connect√©', 'warning');
                    }
                }
            } catch (error) {
                status += '<div class="status error">‚ùå Erreur v√©rification authentification: ' + error.message + '</div>';
                log('Erreur v√©rification authentification: ' + error.message, 'error');
            }
            
            statusDiv.innerHTML = status;
        }

        async function testTopScore() {
            const score = parseInt(document.getElementById('test-score').value) || 100;
            const resultDiv = document.getElementById('top-score-result');
            
            log(`Test v√©rification top score pour: ${score}`);
            resultDiv.innerHTML = '<div class="status info">üîç V√©rification en cours...</div>';
            
            try {
                // Simuler la fonction checkIfTopScore du jeu
                let isTopScore = false;
                
                // V√©rifier avec les scores en ligne si disponible
                if (window.EnigmaScrollFirebase && window.EnigmaScrollFirebase.isAvailable) {
                    log('V√©rification avec les scores en ligne...');
                    try {
                        const onlineScores = await window.EnigmaScrollFirebase.getTopScores('alltime', null, 10);
                        log(`R√©cup√©r√© ${onlineScores.length} scores en ligne`);
                        
                        if (onlineScores && onlineScores.length > 0) {
                            if (onlineScores.length < 10) {
                                isTopScore = true;
                                log('Moins de 10 scores en ligne, c\'est un top score !');
                            } else {
                                const lowestTopScore = onlineScores[onlineScores.length - 1].score;
                                isTopScore = score > lowestTopScore;
                                log(`Score ${score} vs plus bas top score ${lowestTopScore}: ${isTopScore ? 'TOP SCORE!' : 'pas un top score'}`);
                            }
                        }
                    } catch (error) {
                        log('Erreur lors de la v√©rification des scores en ligne: ' + error.message, 'warning');
                    }
                }
                
                // Fallback: v√©rifier avec les scores locaux
                if (!window.EnigmaScrollFirebase || !window.EnigmaScrollFirebase.isAvailable) {
                    log('V√©rification avec les scores locaux...');
                    const localScores = JSON.parse(localStorage.getItem('enigmaScrollMainScores') || '[]');
                    
                    if (localScores.length === 0 || localScores.length < 10) {
                        isTopScore = true;
                        log('Pas assez de scores locaux, c\'est un top score !');
                    } else {
                        const lowestLocalScore = localScores[localScores.length - 1]?.score || 0;
                        isTopScore = score > lowestLocalScore;
                        log(`Score ${score} vs plus bas score local ${lowestLocalScore}: ${isTopScore ? 'TOP SCORE LOCAL!' : 'pas un top score local'}`);
                    }
                }
                
                const resultClass = isTopScore ? 'success' : 'info';
                const resultIcon = isTopScore ? 'üèÜ' : 'üìä';
                resultDiv.innerHTML = `<div class="status ${resultClass}">${resultIcon} Score ${score}: ${isTopScore ? 'TOP SCORE !' : 'Score normal'}</div>`;
                
            } catch (error) {
                log('Erreur lors du test top score: ' + error.message, 'error');
                resultDiv.innerHTML = '<div class="status error">‚ùå Erreur: ' + error.message + '</div>';
            }
        }

        async function testRewards(isTopScore) {
            const score = parseInt(document.getElementById('reward-score').value) || 150;
            const resultDiv = document.getElementById('reward-result');
            
            log(`Test attribution r√©compenses - Score: ${score}, Top Score: ${isTopScore}`);
            resultDiv.innerHTML = '<div class="status info">üéÅ Attribution en cours...</div>';
            
            try {
                if (!window.rewardService) {
                    throw new Error('RewardService non disponible');
                }
                
                if (!window.rewardService.canGiveRewards()) {
                    throw new Error('Utilisateur non connect√© pour les r√©compenses');
                }
                
                const result = await window.rewardService.giveEnigmaScrollRewards(isTopScore, score);
                
                if (result.success) {
                    log(`R√©compenses attribu√©es avec succ√®s: +${result.rewards.xp} XP, +${result.rewards.coins} coins`);
                    const rewardText = isTopScore ? 
                        `üèÜ TOP SCORE ! +${result.rewards.xp} XP, +${result.rewards.coins} coins` :
                        `üéÅ R√©compenses: +${result.rewards.xp} XP, +${result.rewards.coins} coins`;
                    resultDiv.innerHTML = `<div class="status success">${rewardText}</div>`;
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
                
            } catch (error) {
                log('Erreur lors du test r√©compenses: ' + error.message, 'error');
                resultDiv.innerHTML = '<div class="status error">‚ùå Erreur: ' + error.message + '</div>';
            }
        }

        async function testOnlineScores() {
            const resultDiv = document.getElementById('online-scores-result');
            
            log('Test r√©cup√©ration scores en ligne...');
            resultDiv.innerHTML = '<div class="status info">üì° R√©cup√©ration en cours...</div>';
            
            try {
                if (!window.EnigmaScrollFirebase) {
                    throw new Error('EnigmaScrollFirebase non disponible');
                }
                
                if (!window.EnigmaScrollFirebase.isAvailable) {
                    throw new Error('Firebase non disponible');
                }
                
                const scores = await window.EnigmaScrollFirebase.getTopScores('alltime', null, 10);
                
                log(`R√©cup√©r√© ${scores.length} scores en ligne`);
                
                let scoresHtml = `<div class="status success">‚úÖ ${scores.length} scores r√©cup√©r√©s</div>`;
                if (scores.length > 0) {
                    scoresHtml += '<div style="margin-top: 10px;"><strong>Top 5:</strong><br>';
                    scores.slice(0, 5).forEach((score, index) => {
                        scoresHtml += `${index + 1}. ${score.username}: ${score.score} points<br>`;
                        log(`${index + 1}. ${score.username}: ${score.score} points`);
                    });
                    scoresHtml += '</div>';
                }
                
                resultDiv.innerHTML = scoresHtml;
                
            } catch (error) {
                log('Erreur lors du test scores en ligne: ' + error.message, 'error');
                resultDiv.innerHTML = '<div class="status error">‚ùå Erreur: ' + error.message + '</div>';
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('Page de test charg√©e');
            
            // Attendre que les services soient charg√©s
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
        });
    </script>
</body>
</html> 