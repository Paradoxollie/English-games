<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Syst√®me de Comptage des Joueurs</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <!-- Services -->
    <script type="module" src="scripts/auth-service.js"></script>
    <script type="module" src="scripts/game-stats-service.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .test-section {
            background-color: #1e1e1e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .test-button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background-color: #27ae60;
        }
        
        .test-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background-color: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }
        
        .status.error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        
        .status.warning {
            background-color: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
            color: #f39c12;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .stat-title {
            color: #f39c12;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2ecc71;
        }
        
        .stat-detail {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .log-container {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .clear-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Test Syst√®me de Comptage des Joueurs</h1>
        <p>Outil pour tester et v√©rifier le syst√®me de comptage des joueurs uniques et des parties jou√©es.</p>
        
        <!-- Section d'initialisation -->
        <div class="test-section">
            <h2>üîß Initialisation</h2>
            <button class="test-button" onclick="initializeServices()">Initialiser les Services</button>
            <div id="init-status"></div>
        </div>
        
        <!-- Section de simulation de parties -->
        <div class="test-section">
            <h2>üéØ Simulation de Parties</h2>
            <div style="margin-bottom: 15px;">
                <label for="game-select">Jeu :</label>
                <select id="game-select" style="margin-left: 10px; padding: 5px; background: #333; color: white; border: 1px solid #555;">
                    <option value="speed-verb-challenge">Speed Verb Challenge</option>
                    <option value="enigma-scroll">Enigma Scroll</option>
                    <option value="word-memory-game">Word Memory Game</option>
                    <option value="memory-matrix">Memory Matrix</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="player-id">ID Joueur :</label>
                <input type="text" id="player-id" placeholder="user123 ou laissez vide pour anonyme" style="margin-left: 10px; padding: 5px; background: #333; color: white; border: 1px solid #555;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="score-input">Score :</label>
                <input type="number" id="score-input" value="100" min="0" max="10000" style="margin-left: 10px; padding: 5px; background: #333; color: white; border: 1px solid #555;">
            </div>
            <button class="test-button" onclick="simulateGamePlay()">Simuler une Partie</button>
            <button class="test-button" onclick="simulateMultipleGames()">Simuler 5 Parties</button>
            <button class="test-button" onclick="simulateUniquePlayer()">Simuler Nouveau Joueur Unique</button>
            <div id="simulation-status"></div>
        </div>
        
        <!-- Section d'affichage des statistiques -->
        <div class="test-section">
            <h2>üìä Statistiques des Jeux</h2>
            <button class="test-button" onclick="loadAllStats()">Charger les Statistiques</button>
            <button class="test-button" onclick="clearCache()">Vider le Cache</button>
            <div id="stats-container">
                <div class="stats-grid" id="stats-grid">
                    <!-- Les statistiques seront affich√©es ici -->
                </div>
            </div>
        </div>
        
        <!-- Section de test des pages -->
        <div class="test-section">
            <h2>üåê Test Affichage Pages</h2>
            <button class="test-button" onclick="testIndexPage()">Tester index.html</button>
            <button class="test-button" onclick="testGamesPage()">Tester games.html</button>
            <div id="pages-status"></div>
        </div>
        
        <!-- Console de logs -->
        <div class="test-section">
            <h2>üìù Console de Logs</h2>
            <button class="clear-btn" onclick="clearLogs()">üóëÔ∏è Effacer</button>
            <div id="log-container" class="log-container"></div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBfy1clmJoOl_0r3rQKhJb8ooPWkQgBuQs",
            authDomain: "english-games-41017.firebaseapp.com",
            projectId: "english-games-41017",
            storageBucket: "english-games-41017.appspot.com",
            messagingSenderId: "1062036556501",
            appId: "1:1062036556501:web:e74b7a0c8b8b8b8b8b8b8b"
        };

        // Initialiser Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Variables globales
        let servicesInitialized = false;

        // Fonction de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            
            let prefix = '';
            switch(type) {
                case 'success': prefix = '‚úÖ'; break;
                case 'error': prefix = '‚ùå'; break;
                case 'warning': prefix = '‚ö†Ô∏è'; break;
                default: prefix = '‚ÑπÔ∏è'; break;
            }
            
            logEntry.textContent = `[${timestamp}] ${prefix} ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Aussi dans la console du navigateur
            console.log(`[PlayerCountTest] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
        }

        // Initialisation des services
        async function initializeServices() {
            log('Initialisation des services...');
            
            try {
                // Attendre que les services se chargent
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (window.gameStatsService) {
                    const success = await window.gameStatsService.init();
                    if (success) {
                        servicesInitialized = true;
                        document.getElementById('init-status').innerHTML = '<div class="status success">‚úÖ Services initialis√©s avec succ√®s</div>';
                        log('Services initialis√©s avec succ√®s', 'success');
                    } else {
                        document.getElementById('init-status').innerHTML = '<div class="status error">‚ùå √âchec de l\'initialisation</div>';
                        log('√âchec de l\'initialisation des services', 'error');
                    }
                } else {
                    document.getElementById('init-status').innerHTML = '<div class="status error">‚ùå GameStatsService non disponible</div>';
                    log('GameStatsService non disponible', 'error');
                }
            } catch (error) {
                document.getElementById('init-status').innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
                log(`Erreur d'initialisation: ${error.message}`, 'error');
            }
        }

        // Simulation d'une partie
        async function simulateGamePlay() {
            if (!servicesInitialized) {
                alert('Veuillez d\'abord initialiser les services');
                return;
            }

            const gameId = document.getElementById('game-select').value;
            const playerId = document.getElementById('player-id').value.trim() || null;
            const score = parseInt(document.getElementById('score-input').value) || 100;

            log(`Simulation d'une partie: ${gameId}, joueur: ${playerId || 'anonyme'}, score: ${score}`);

            try {
                const success = await window.gameStatsService.recordGamePlay(gameId, playerId, score);
                if (success) {
                    document.getElementById('simulation-status').innerHTML = '<div class="status success">‚úÖ Partie enregistr√©e avec succ√®s</div>';
                    log('Partie enregistr√©e avec succ√®s', 'success');
                } else {
                    document.getElementById('simulation-status').innerHTML = '<div class="status error">‚ùå √âchec de l\'enregistrement</div>';
                    log('√âchec de l\'enregistrement de la partie', 'error');
                }
            } catch (error) {
                document.getElementById('simulation-status').innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
                log(`Erreur lors de la simulation: ${error.message}`, 'error');
            }
        }

        // Simulation de plusieurs parties
        async function simulateMultipleGames() {
            if (!servicesInitialized) {
                alert('Veuillez d\'abord initialiser les services');
                return;
            }

            const gameId = document.getElementById('game-select').value;
            log(`Simulation de 5 parties pour ${gameId}...`);

            try {
                for (let i = 0; i < 5; i++) {
                    const playerId = Math.random() > 0.5 ? `player${Math.floor(Math.random() * 100)}` : null;
                    const score = Math.floor(Math.random() * 1000) + 50;
                    
                    await window.gameStatsService.recordGamePlay(gameId, playerId, score);
                    log(`Partie ${i + 1}/5 enregistr√©e (joueur: ${playerId || 'anonyme'}, score: ${score})`);
                    
                    // Petite pause entre les parties
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                document.getElementById('simulation-status').innerHTML = '<div class="status success">‚úÖ 5 parties simul√©es avec succ√®s</div>';
                log('5 parties simul√©es avec succ√®s', 'success');
            } catch (error) {
                document.getElementById('simulation-status').innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
                log(`Erreur lors de la simulation multiple: ${error.message}`, 'error');
            }
        }

        // Simulation d'un nouveau joueur unique
        async function simulateUniquePlayer() {
            if (!servicesInitialized) {
                alert('Veuillez d\'abord initialiser les services');
                return;
            }

            const gameId = document.getElementById('game-select').value;
            const uniquePlayerId = `unique_player_${Date.now()}`;
            const score = Math.floor(Math.random() * 500) + 100;

            log(`Simulation d'un nouveau joueur unique: ${uniquePlayerId}`);

            try {
                await window.gameStatsService.recordGamePlay(gameId, uniquePlayerId, score);
                document.getElementById('simulation-status').innerHTML = `<div class="status success">‚úÖ Nouveau joueur unique cr√©√©: ${uniquePlayerId}</div>`;
                log(`Nouveau joueur unique cr√©√©: ${uniquePlayerId}`, 'success');
            } catch (error) {
                document.getElementById('simulation-status').innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
                log(`Erreur lors de la cr√©ation du joueur unique: ${error.message}`, 'error');
            }
        }

        // Chargement des statistiques
        async function loadAllStats() {
            if (!servicesInitialized) {
                alert('Veuillez d\'abord initialiser les services');
                return;
            }

            log('Chargement des statistiques...');

            try {
                const games = ['speed-verb-challenge', 'enigma-scroll', 'word-memory-game', 'memory-matrix'];
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = '';

                for (const gameId of games) {
                    const stats = await window.gameStatsService.getGameStats(gameId);
                    
                    const statCard = document.createElement('div');
                    statCard.className = 'stat-card';
                    statCard.innerHTML = `
                        <div class="stat-title">${gameId}</div>
                        <div class="stat-value">${stats.playCount}</div>
                        <div class="stat-detail">Parties jou√©es</div>
                        <div class="stat-detail">Joueurs uniques: ${stats.uniquePlayersCount || 0}</div>
                        <div class="stat-detail">Note moyenne: ${stats.averageRating}/5 (${stats.ratingCount} avis)</div>
                        <div class="stat-detail">Score moyen: ${stats.averageScore}</div>
                    `;
                    
                    statsGrid.appendChild(statCard);
                    log(`Stats charg√©es pour ${gameId}: ${stats.playCount} parties, ${stats.uniquePlayersCount || 0} joueurs uniques`);
                }

                log('Toutes les statistiques charg√©es', 'success');
            } catch (error) {
                log(`Erreur lors du chargement des stats: ${error.message}`, 'error');
            }
        }

        // Vider le cache
        function clearCache() {
            if (window.gameStatsService && window.gameStatsService.cache) {
                window.gameStatsService.cache.clear();
                log('Cache vid√©', 'success');
            }
        }

        // Test des pages
        function testIndexPage() {
            window.open('index.html', '_blank');
            log('Page index.html ouverte dans un nouvel onglet');
        }

        function testGamesPage() {
            window.open('games.html', '_blank');
            log('Page games.html ouverte dans un nouvel onglet');
        }

        // Auto-initialisation
        document.addEventListener('DOMContentLoaded', () => {
            log('Page de test charg√©e');
            
            // Attendre un peu que les services se chargent
            setTimeout(() => {
                initializeServices();
            }, 1000);
        });
    </script>
</body>
</html> 