<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Profil - English Quest</title>
  <meta name="description" content="Gérez votre profil et vos paramètres sur English Quest, la plateforme ludique pour apprendre l'anglais.">
  <meta name="theme-color" content="#c9aa71">

  <!-- Préchargement des polices -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&display=swap" as="style">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" as="style">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Spectral:wght@200;300;400;500;600;700&display=swap" as="style">

  <!-- Styles -->
  <link rel="stylesheet" href="../styles/main.css">

  <!-- Favicon -->
  <link rel="icon" href="../assets/icons/favicon.ico">
  <link rel="apple-touch-icon" href="../assets/icons/apple-touch-icon.png">
</head>
<body class="page-profile">
  <!-- Lien d'évitement pour l'accessibilité -->
  <a href="#main-content" class="skip-link">Aller au contenu principal</a>

  <!-- En-tête -->
  <header class="header">
    <div class="container">
      <div class="header__content">
        <a href="index.html" class="header__logo">
          <img src="../assets/images/logo.gif" alt="English Quest Logo" width="180" height="60">
        </a>

        <nav class="header__nav" aria-label="Navigation principale">
          <ul class="nav__list">
            <li class="nav__item"><a href="index.html" class="nav__link">Accueil</a></li>
            <li class="nav__item"><a href="all-games.html" class="nav__link">Jeux</a></li>
            <li class="nav__item"><a href="courses.html" class="nav__link">Cours</a></li>
            <li class="nav__item"><a href="leaderboard.html" class="nav__link">Classement</a></li>
            <li class="nav__item"><a href="contact.html" class="nav__link">Contact</a></li>
          </ul>
        </nav>

        <div class="header__actions">
          <button id="login-button" class="btn btn-outline-primary">Connexion</button>
          <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-expanded="false" aria-label="Menu">
            <span class="mobile-menu-toggle__bar"></span>
            <span class="mobile-menu-toggle__bar"></span>
            <span class="mobile-menu-toggle__bar"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Menu mobile -->
    <div id="mobile-menu" class="mobile-menu">
      <nav class="mobile-menu__nav" aria-label="Navigation mobile">
        <ul class="mobile-menu__list">
          <li class="mobile-menu__item"><a href="index.html" class="mobile-menu__link">Accueil</a></li>
          <li class="mobile-menu__item"><a href="all-games.html" class="mobile-menu__link">Jeux</a></li>
          <li class="mobile-menu__item"><a href="courses.html" class="mobile-menu__link">Cours</a></li>
          <li class="mobile-menu__item"><a href="leaderboard.html" class="mobile-menu__link">Classement</a></li>
          <li class="mobile-menu__item"><a href="contact.html" class="mobile-menu__link">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Contenu principal -->
  <main id="main-content" class="main">
    <div class="container">
      <!-- Fil d'Ariane -->
      <ul class="breadcrumb">
        <li class="breadcrumb__item"><a href="index.html" class="breadcrumb__link">Accueil</a></li>
        <li class="breadcrumb__item"><a href="profile.html" class="breadcrumb__link">Mon Profil</a></li>
      </ul>

      <!-- Titre de la page -->
      <div class="section__header">
        <h1 class="section__title">Mon Profil</h1>
        <p class="section__subtitle">Gérez votre profil et vos paramètres</p>
      </div>

      <!-- Onglets -->
      <div class="tabs">
        <div class="tabs__item">
          <a href="#profile" class="tabs__link tabs__link--active" data-tab="profile">Profil</a>
        </div>
        <div class="tabs__item">
          <a href="#scores" class="tabs__link" data-tab="scores">Mes Scores</a>
        </div>
        <div class="tabs__item">
          <a href="#settings" class="tabs__link" data-tab="settings">Paramètres</a>
        </div>
      </div>

      <!-- Contenu des onglets -->
      <div class="tab-content">
        <!-- Onglet Profil -->
        <div class="tab-pane active" id="profile-tab">
          <div id="profile-container"></div>
        </div>

        <!-- Onglet Scores -->
        <div class="tab-pane" id="scores-tab" style="display: none;">
          <div class="panel">
            <div class="panel__header">
              <h2 class="panel__title">Mes Meilleurs Scores</h2>
            </div>
            <div class="panel__body">
              <div id="user-scores-container">
                <div class="loading">
                  <div class="loading__spinner"></div>
                  <p class="loading__text">Chargement de vos scores...</p>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel__header">
              <h2 class="panel__title">Mes Succès</h2>
            </div>
            <div class="panel__body">
              <div id="user-achievements-container">
                <div class="loading">
                  <div class="loading__spinner"></div>
                  <p class="loading__text">Chargement de vos succès...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Onglet Paramètres -->
        <div class="tab-pane" id="settings-tab" style="display: none;">
          <div id="settings-container"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Pied de page -->
  <footer class="footer">
    <div class="container">
      <div class="footer__content">
        <div class="footer__brand">
          <a href="index.html" class="footer__logo">
            <img src="../assets/images/logo-footer.gif" alt="English Quest Logo" width="150" height="50">
          </a>
          <p class="footer__tagline">Apprendre l'anglais n'a jamais été aussi amusant</p>
        </div>

        <div class="footer__links">
          <div class="footer__column">
            <h3 class="footer__title">Navigation</h3>
            <ul class="footer__list">
              <li><a href="index.html" class="footer__link">Accueil</a></li>
              <li><a href="all-games.html" class="footer__link">Jeux</a></li>
              <li><a href="courses.html" class="footer__link">Cours</a></li>
              <li><a href="leaderboard.html" class="footer__link">Classement</a></li>
              <li><a href="contact.html" class="footer__link">Contact</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h3 class="footer__title">Légal</h3>
            <ul class="footer__list">
              <li><a href="terms.html" class="footer__link">Conditions d'utilisation</a></li>
              <li><a href="privacy.html" class="footer__link">Politique de confidentialité</a></li>
              <li><a href="cookies.html" class="footer__link">Politique de cookies</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h3 class="footer__title">Suivez-nous</h3>
            <ul class="footer__social">
              <li><a href="#" class="footer__social-link" aria-label="Facebook">Facebook</a></li>
              <li><a href="#" class="footer__social-link" aria-label="Twitter">Twitter</a></li>
              <li><a href="#" class="footer__social-link" aria-label="Instagram">Instagram</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="footer__bottom">
        <p class="footer__copyright">&copy; 2023 English Quest. Tous droits réservés.</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script type="module">
    import app from '../js/core/app.js';
    import UserAccount from '../components/common/user-account.js';

    // Initialiser l'application
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialiser l'application
        await app.init();

        // Initialiser le composant de compte utilisateur
        const userAccount = new UserAccount(app.authService);

        // Rendre le profil et les paramètres
        userAccount.renderProfile('profile-container');
        userAccount.renderSettings('settings-container');

        // Gérer les onglets
        const tabLinks = document.querySelectorAll('.tabs__link');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();

            // Supprimer la classe active de tous les onglets
            tabLinks.forEach(tab => tab.classList.remove('tabs__link--active'));

            // Ajouter la classe active à l'onglet cliqué
            link.classList.add('tabs__link--active');

            // Afficher le contenu de l'onglet
            const tabId = link.getAttribute('data-tab');
            tabPanes.forEach(pane => {
              pane.style.display = 'none';
              if (pane.id === `${tabId}-tab`) {
                pane.style.display = 'block';
              }
            });

            // Charger les scores si nécessaire
            if (tabId === 'scores') {
              loadUserScores();
            }
          });
        });

        // Charger les scores de l'utilisateur
        async function loadUserScores() {
          const scoresContainer = document.getElementById('user-scores-container');
          const achievementsContainer = document.getElementById('user-achievements-container');

          if (!app.authService.isLoggedIn() || !app.authService.hasProfile()) {
            scoresContainer.innerHTML = `
              <div class="empty-state">
                <p class="empty-state__text">Connectez-vous pour voir vos scores</p>
                <button id="login-scores-btn" class="btn btn-primary">Se connecter</button>
              </div>
            `;

            achievementsContainer.innerHTML = `
              <div class="empty-state">
                <p class="empty-state__text">Connectez-vous pour voir vos succès</p>
              </div>
            `;

            // Ajouter l'événement de connexion
            const loginScoresBtn = document.getElementById('login-scores-btn');
            loginScoresBtn.addEventListener('click', () => {
              // Ouvrir le modal d'authentification
              const event = new CustomEvent('open-auth-modal');
              document.dispatchEvent(event);
            });

            return;
          }

          try {
            // Charger les scores
            const scores = await app.authService.getUserScores(null, 10);

            if (scores.length === 0) {
              scoresContainer.innerHTML = `
                <div class="empty-state">
                  <p class="empty-state__text">Vous n'avez pas encore de scores enregistrés</p>
                  <a href="all-games.html" class="btn btn-primary">Jouer maintenant</a>
                </div>
              `;
            } else {
              // Créer le tableau de scores
              let html = `
                <table class="table">
                  <thead>
                    <tr>
                      <th>Jeu</th>
                      <th>Score</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              scores.forEach(score => {
                const date = new Date(score.timestamp).toLocaleDateString();
                html += `
                  <tr>
                    <td>${score.gameId}</td>
                    <td>${score.score.toLocaleString()}</td>
                    <td>${date}</td>
                  </tr>
                `;
              });

              html += `
                  </tbody>
                </table>
              `;

              scoresContainer.innerHTML = html;
            }

            // Charger les succès
            const profile = app.authService.userProfile;
            const achievements = profile.stats?.achievements || [];

            if (achievements.length === 0) {
              achievementsContainer.innerHTML = `
                <div class="empty-state">
                  <p class="empty-state__text">Vous n'avez pas encore de succès débloqués</p>
                  <a href="all-games.html" class="btn btn-primary">Jouer pour débloquer des succès</a>
                </div>
              `;
            } else {
              // Créer la liste des succès
              let html = `<div class="achievements">`;

              achievements.forEach(achievement => {
                html += `
                  <div class="achievement">
                    <div class="achievement__icon">${achievement.icon || '🏆'}</div>
                    <div class="achievement__content">
                      <h3 class="achievement__title">${achievement.title}</h3>
                      <p class="achievement__description">${achievement.description}</p>
                      <p class="achievement__date">Débloqué le ${new Date(achievement.unlockedAt).toLocaleDateString()}</p>
                    </div>
                  </div>
                `;
              });

              html += `</div>`;

              achievementsContainer.innerHTML = html;
            }
          } catch (error) {
            console.error('Erreur lors du chargement des scores:', error);

            scoresContainer.innerHTML = `
              <div class="error-state">
                <p class="error-state__text">Une erreur s'est produite lors du chargement des scores</p>
                <button id="retry-scores-btn" class="btn btn-primary">Réessayer</button>
              </div>
            `;

            // Ajouter l'événement de nouvelle tentative
            const retryScoresBtn = document.getElementById('retry-scores-btn');
            retryScoresBtn.addEventListener('click', () => loadUserScores());
          }
        }

        // Mettre à jour le bouton de connexion
        function updateLoginButton() {
          const loginButton = document.getElementById('login-button');

          if (app.authService.isLoggedIn() && app.authService.hasProfile()) {
            loginButton.textContent = app.authService.getUsername();
            loginButton.classList.add('btn-primary');
            loginButton.classList.remove('btn-outline-primary');

            // Changer l'événement pour rediriger vers le profil
            loginButton.removeEventListener('click', openAuthModal);
            loginButton.addEventListener('click', () => {
              window.location.href = 'profile.html';
            });
          } else {
            loginButton.textContent = 'Connexion';
            loginButton.classList.add('btn-outline-primary');
            loginButton.classList.remove('btn-primary');

            // Changer l'événement pour ouvrir le modal d'authentification
            loginButton.removeEventListener('click', () => {
              window.location.href = 'profile.html';
            });
            loginButton.addEventListener('click', openAuthModal);
          }
        }

        // Ouvrir le modal d'authentification
        function openAuthModal() {
          const event = new CustomEvent('open-auth-modal');
          document.dispatchEvent(event);
        }

        // Écouter les changements d'état d'authentification
        document.addEventListener('auth-state-changed', (e) => {
          updateLoginButton();

          // Recharger les composants
          userAccount.renderProfile('profile-container');
          userAccount.renderSettings('settings-container');

          // Recharger les scores si l'onglet est actif
          const scoresTab = document.querySelector('.tabs__link[data-tab="scores"]');
          if (scoresTab.classList.contains('tabs__link--active')) {
            loadUserScores();
          }
        });

        // Initialiser l'état du bouton de connexion
        updateLoginButton();

        // Ajouter l'événement d'ouverture du modal d'authentification
        document.getElementById('login-button').addEventListener('click', openAuthModal);
      } catch (error) {
        console.error('Erreur lors de l\'initialisation de la page de profil:', error);
      }
    });
  </script>
</body>
</html>
