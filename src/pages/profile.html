<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Profil - English Quest Reborn</title>
  <meta name="description" content="Gérez votre profil et vos paramètres sur English Quest, la plateforme ludique pour apprendre l'anglais.">
  <meta name="theme-color" content="#c9aa71">

  <!-- Préchargement des polices -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&display=swap" as="style">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" as="style">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Spectral:wght@200;300;400;500;600;700&display=swap" as="style">

  <!-- Styles -->
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/profile.css">

  <!-- Favicon -->
  <link rel="icon" href="../assets/icons/favicon.ico">
  <link rel="apple-touch-icon" href="../assets/icons/apple-touch-icon.png">
</head>
<body class="page-profile">
  <!-- Lien d'évitement pour l'accessibilité -->
  <a href="#main-content" class="skip-link">Aller au contenu principal</a>

  <!-- En-tête -->
  <header class="header">
    <div class="container">
      <div class="header__content">
        <a href="../index.html" class="header__logo">
          <img src="../assets/images/logo.gif" alt="English Quest Logo" width="180" height="60">
        </a>

        <nav class="header__nav" aria-label="Navigation principale">
          <ul class="nav__list">
            <li class="nav__item"><a href="../index.html" class="nav__link">Accueil</a></li>
            <li class="nav__item"><a href="../games.html" class="nav__link">Jeux</a></li>
            <li class="nav__item"><a href="../courses.html" class="nav__link">Cours</a></li>
            <li class="nav__item"><a href="../leaderboard.html" class="nav__link">Classement</a></li>
            <li class="nav__item"><a href="../contact.html" class="nav__link">Contact</a></li>
          </ul>
        </nav>

        <div class="header__actions">
          <button id="login-button" class="btn btn-outline-primary">Connexion</button>
          <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-expanded="false" aria-label="Menu">
            <span class="mobile-menu-toggle__bar"></span>
            <span class="mobile-menu-toggle__bar"></span>
            <span class="mobile-menu-toggle__bar"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Menu mobile -->
    <div id="mobile-menu" class="mobile-menu">
      <nav class="mobile-menu__nav" aria-label="Navigation mobile">
        <ul class="mobile-menu__list">
          <li class="mobile-menu__item"><a href="../index.html" class="mobile-menu__link">Accueil</a></li>
          <li class="mobile-menu__item"><a href="../games.html" class="mobile-menu__link">Jeux</a></li>
          <li class="mobile-menu__item"><a href="../courses.html" class="mobile-menu__link">Cours</a></li>
          <li class="mobile-menu__item"><a href="../leaderboard.html" class="mobile-menu__link">Classement</a></li>
          <li class="mobile-menu__item"><a href="../contact.html" class="mobile-menu__link">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Contenu principal -->
  <main id="main-content" class="main">
    <div class="container">
      <!-- Fil d'Ariane -->
      <ul class="breadcrumb">
        <li class="breadcrumb__item"><a href="../index.html" class="breadcrumb__link">Accueil</a></li>
        <li class="breadcrumb__item"><a href="profile.html" class="breadcrumb__link">Mon Profil</a></li>
      </ul>

      <!-- Titre de la page -->
      <div class="section__header">
        <h1 class="section__title">Mon Profil</h1>
        <p class="section__subtitle">Gérez votre profil et vos paramètres</p>
      </div>

      <!-- Onglets -->
      <div class="tabs">
        <div class="tabs__item">
          <a href="#profile" class="tabs__link tabs__link--active" data-tab="profile">Profil</a>
        </div>
        <div class="tabs__item">
          <a href="#scores" class="tabs__link" data-tab="scores">Mes Scores</a>
        </div>
        <div class="tabs__item">
          <a href="#settings" class="tabs__link" data-tab="settings">Paramètres</a>
        </div>
      </div>

      <!-- Contenu des onglets -->
      <div class="tabs__content">
        <!-- Onglet Profil -->
        <div id="profile" class="tabs__pane tabs__pane--active">
          <div class="profile-section">
            <div class="profile-header">
              <div class="profile-avatar">
                <img id="avatar-preview" src="../assets/avatars/default.png" alt="Avatar">
                <button id="change-avatar-btn" class="btn btn-secondary">Changer d'avatar</button>
              </div>
              <div class="profile-info">
                <h2 id="username">Chargement...</h2>
                <p id="user-level">Niveau: Chargement...</p>
                <p id="user-xp">XP: Chargement...</p>
                <p id="user-coins">Pièces: Chargement...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Onglet Scores -->
        <div id="scores" class="tabs__pane">
          <div class="scores-section">
            <div id="user-scores-container">
              <div class="empty-state">
                <p class="empty-state__text">Chargement des scores...</p>
              </div>
            </div>
            <div id="user-achievements-container">
              <div class="empty-state">
                <p class="empty-state__text">Chargement des succès...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Onglet Paramètres -->
        <div id="settings" class="tabs__pane">
          <div class="settings-section">
            <form id="profile-form" class="form">
              <div class="form__group">
                <label for="display-name" class="form__label">Nom d'affichage</label>
                <input type="text" id="display-name" class="form__input" required>
              </div>
              <div class="form__group">
                <label for="email" class="form__label">Email</label>
                <input type="email" id="email" class="form__input" required>
              </div>
              <div class="form__group">
                <label class="form__label">Notifications</label>
                <div class="toggle">
                  <input type="checkbox" id="notifications-toggle" class="toggle__input">
                  <label for="notifications-toggle" class="toggle__label"></label>
                </div>
              </div>
              <div class="form__group">
                <label class="form__label">Son</label>
                <div class="toggle">
                  <input type="checkbox" id="sound-toggle" class="toggle__input">
                  <label for="sound-toggle" class="toggle__label"></label>
                </div>
              </div>
              <div class="form__group">
                <label class="form__label">Musique</label>
                <div class="toggle">
                  <input type="checkbox" id="music-toggle" class="toggle__input">
                  <label for="music-toggle" class="toggle__label"></label>
                </div>
              </div>
              <div class="form__actions">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" id="logout-btn" class="btn btn-danger">Déconnexion</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Pied de page -->
  <footer class="footer">
    <div class="container">
      <div class="footer__content">
        <div class="footer__brand">
          <a href="../index.html" class="footer__logo">
            <img src="../assets/images/logo-footer.gif" alt="English Quest Logo" width="150" height="50">
          </a>
          <p class="footer__tagline">Apprendre l'anglais n'a jamais été aussi amusant</p>
        </div>

        <div class="footer__links">
          <div class="footer__column">
            <h3 class="footer__title">Navigation</h3>
            <ul class="footer__list">
              <li><a href="../index.html" class="footer__link">Accueil</a></li>
              <li><a href="../games.html" class="footer__link">Jeux</a></li>
              <li><a href="../courses.html" class="footer__link">Cours</a></li>
              <li><a href="../leaderboard.html" class="footer__link">Classement</a></li>
              <li><a href="../contact.html" class="footer__link">Contact</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h3 class="footer__title">Légal</h3>
            <ul class="footer__list">
              <li><a href="../terms.html" class="footer__link">Conditions d'utilisation</a></li>
              <li><a href="../privacy.html" class="footer__link">Politique de confidentialité</a></li>
              <li><a href="../cookies.html" class="footer__link">Politique de cookies</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h3 class="footer__title">Suivez-nous</h3>
            <ul class="footer__social">
              <li><a href="#" class="footer__social-link" aria-label="Facebook">Facebook</a></li>
              <li><a href="#" class="footer__social-link" aria-label="Twitter">Twitter</a></li>
              <li><a href="#" class="footer__social-link" aria-label="Instagram">Instagram</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="footer__bottom">
        <p class="footer__copyright">&copy; 2023 English Quest. Tous droits réservés.</p>
      </div>
    </div>
  </footer>

  <!-- Modal de changement d'avatar -->
  <div id="avatar-modal" class="modal">
    <div class="modal__content">
      <div class="modal__header">
        <h2 class="modal__title">Changer d'avatar</h2>
        <button class="modal__close">&times;</button>
      </div>
      <div class="modal__body">
        <div class="avatar-grid" id="avatar-grid">
          <!-- Les avatars seront chargés dynamiquement -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { initAuth, isAuthenticated, getCurrentProfile, updateProfile, logout } from '../js/services/auth.service.js';
    import { loadUserScores } from '../js/services/score.service.js';
    import { loadUserAchievements } from '../js/services/achievement.service.js';
    import { loadAvailableAvatars, updateUserAvatar } from '../js/services/avatar.service.js';

    // Initialiser l'authentification
    await initAuth();

    // Vérifier si l'utilisateur est authentifié
    if (!isAuthenticated()) {
      window.location.href = '../login.html';
    }

    // Éléments DOM
    const usernameElement = document.getElementById('username');
    const levelElement = document.getElementById('user-level');
    const xpElement = document.getElementById('user-xp');
    const coinsElement = document.getElementById('user-coins');
    const avatarPreview = document.getElementById('avatar-preview');
    const changeAvatarBtn = document.getElementById('change-avatar-btn');
    const avatarModal = document.getElementById('avatar-modal');
    const avatarGrid = document.getElementById('avatar-grid');
    const profileForm = document.getElementById('profile-form');
    const displayNameInput = document.getElementById('display-name');
    const emailInput = document.getElementById('email');
    const notificationsToggle = document.getElementById('notifications-toggle');
    const soundToggle = document.getElementById('sound-toggle');
    const musicToggle = document.getElementById('music-toggle');
    const logoutButton = document.getElementById('logout-btn');

    // Charger le profil
    async function loadProfile() {
      const profile = getCurrentProfile();
      if (!profile) {
        window.location.href = '../login.html';
        return;
      }

      // Mettre à jour les informations de base
      usernameElement.textContent = profile.username;
      levelElement.textContent = `Niveau: ${profile.level || 1}`;
      xpElement.textContent = `XP: ${profile.xp || 0}`;
      coinsElement.textContent = `Pièces: ${profile.coins || 0}`;

      // Mettre à jour l'avatar
      if (profile.currentAvatar) {
        avatarPreview.src = `../assets/avatars/${profile.currentAvatar}.png`;
      }

      // Mettre à jour le formulaire
      displayNameInput.value = profile.username;
      emailInput.value = profile.email || '';

      // Mettre à jour les paramètres
      notificationsToggle.checked = profile.settings?.notifications ?? true;
      soundToggle.checked = profile.settings?.sound ?? true;
      musicToggle.checked = profile.settings?.music ?? true;
    }

    // Charger les scores
    async function loadScores() {
      const scoresContainer = document.getElementById('user-scores-container');
      const achievementsContainer = document.getElementById('user-achievements-container');

      try {
        const scores = await loadUserScores();
        const achievements = await loadUserAchievements();

        // Afficher les scores
        if (scores.length > 0) {
          scoresContainer.innerHTML = `
            <div class="scores-list">
              ${scores.map(score => `
                <div class="score-item">
                  <span class="score-game">${score.game}</span>
                  <span class="score-value">${score.value}</span>
                  <span class="score-date">${new Date(score.date).toLocaleDateString()}</span>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          scoresContainer.innerHTML = `
            <div class="empty-state">
              <p class="empty-state__text">Aucun score enregistré</p>
            </div>
          `;
        }

        // Afficher les succès
        if (achievements.length > 0) {
          achievementsContainer.innerHTML = `
            <div class="achievements-list">
              ${achievements.map(achievement => `
                <div class="achievement-item">
                  <img src="../assets/achievements/${achievement.icon}.png" alt="${achievement.name}" class="achievement-icon">
                  <div class="achievement-info">
                    <h3 class="achievement-name">${achievement.name}</h3>
                    <p class="achievement-description">${achievement.description}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          achievementsContainer.innerHTML = `
            <div class="empty-state">
              <p class="empty-state__text">Aucun succès débloqué</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erreur lors du chargement des scores:', error);
        scoresContainer.innerHTML = `
          <div class="empty-state">
            <p class="empty-state__text">Erreur lors du chargement des scores</p>
          </div>
        `;
        achievementsContainer.innerHTML = `
          <div class="empty-state">
            <p class="empty-state__text">Erreur lors du chargement des succès</p>
          </div>
        `;
      }
    }

    // Charger les avatars disponibles
    async function loadAvatars() {
      try {
        const avatars = await loadAvailableAvatars();
        avatarGrid.innerHTML = avatars.map(avatar => `
          <div class="avatar-item" data-avatar="${avatar.id}">
            <img src="../assets/avatars/${avatar.id}.png" alt="${avatar.name}" class="avatar-preview">
            <div class="avatar-info">
              <h3 class="avatar-name">${avatar.name}</h3>
              <p class="avatar-price">${avatar.price} pièces</p>
            </div>
          </div>
        `).join('');

        // Ajouter les événements de clic
        document.querySelectorAll('.avatar-item').forEach(item => {
          item.addEventListener('click', async () => {
            const avatarId = item.dataset.avatar;
            try {
              await updateUserAvatar(avatarId);
              avatarPreview.src = `../assets/avatars/${avatarId}.png`;
              avatarModal.classList.remove('is-open');
            } catch (error) {
              console.error('Erreur lors de la mise à jour de l\'avatar:', error);
              alert('Erreur lors de la mise à jour de l\'avatar');
            }
          });
        });
      } catch (error) {
        console.error('Erreur lors du chargement des avatars:', error);
        avatarGrid.innerHTML = `
          <div class="empty-state">
            <p class="empty-state__text">Erreur lors du chargement des avatars</p>
          </div>
        `;
      }
    }

    // Gérer les onglets
    document.querySelectorAll('.tabs__link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = link.dataset.tab;

        // Mettre à jour les onglets
        document.querySelectorAll('.tabs__link').forEach(l => l.classList.remove('tabs__link--active'));
        link.classList.add('tabs__link--active');

        // Mettre à jour le contenu
        document.querySelectorAll('.tabs__pane').forEach(pane => pane.classList.remove('tabs__pane--active'));
        document.getElementById(tabId).classList.add('tabs__pane--active');

        // Charger les données si nécessaire
        if (tabId === 'scores') {
          loadScores();
        }
      });
    });

    // Gérer le modal d'avatar
    changeAvatarBtn.addEventListener('click', () => {
      avatarModal.classList.add('is-open');
      loadAvatars();
    });

    document.querySelector('.modal__close').addEventListener('click', () => {
      avatarModal.classList.remove('is-open');
    });

    // Gérer le formulaire de profil
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        const profileData = {
          username: displayNameInput.value,
          email: emailInput.value,
          settings: {
            notifications: notificationsToggle.checked,
            sound: soundToggle.checked,
            music: musicToggle.checked
          }
        };

        await updateProfile(profileData);
        await loadProfile();
        alert('Profil mis à jour avec succès');
      } catch (error) {
        console.error('Erreur lors de la mise à jour du profil:', error);
        alert('Erreur lors de la mise à jour du profil');
      }
    });

    // Gérer la déconnexion
    logoutButton.addEventListener('click', () => {
      logout();
    });

    // Charger le profil au démarrage
    await loadProfile();
  </script>
</body>
</html>
